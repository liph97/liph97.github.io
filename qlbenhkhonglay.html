
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình quản lý Bệnh không lây nhiễm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f8fafc; }
        .tab-active { border-bottom-color: #0ea5e9; color: #0ea5e9; font-weight: 600; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .info-card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); padding: 24px; border: 1px solid #e2e8f0; }
        #history-table-container th.month-header, 
        #history-table-container td.month-cell { min-width: 6rem; max-width: 6rem; text-align: center; }
        #history-table-container td.month-cell { height: 3rem; padding: 0; }
        #history-table-container .sticky-name { min-width: 200px; }
        .tag-input-container { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; background-color: white; }
        .tag { display: inline-flex; align-items: center; background-color: #e0f2fe; color: #0c4a6e; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; }
        .tag-remove { margin-left: 0.5rem; cursor: pointer; color: #38bdf8; font-weight: bold; }
        .history-sub-tab-active { background-color: #0ea5e9; color: white; }
        .sticky-col { position: sticky; left: 0; z-index: 10; }
        #meds-stats-container thead .sticky-col { background-color: #f9fafb; }
        #meds-stats-container tbody .sticky-col { background-color: white; }
        .address-col { max-width: 250px; white-space: normal; word-break: break-word; }
        .detail-tab-active { background-color: #0ea5e9; color: white; }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="max-w-screen-2xl mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-8 pb-4 border-b border-slate-200 flex items-center justify-between">
            <div class="flex items-center gap-4">
                 <img src="https://scontent.fsgn5-8.fna.fbcdn.net/v/t39.30808-6/524684279_737555955794957_5847460689529437942_n.jpg?_nc_cat=109&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=yUT5vr6X-FsQ7kNvwEXpqqU&_nc_oc=AdnrL0MoKg78YWm76MwPWZL7l7KoKxwwyW_kTIzCfDs-xPsLiIA-K2zuPNx71JHeLFs&_nc_zt=23&_nc_ht=scontent.fsgn5-8.fna&_nc_gid=08bC6sMW7HddXUgKA7QxvA&oh=00_AfcMhF7Os7a34ihWhgTLXe5O-1RGzCXPZU1eSX4kDkre9Q&oe=68E4DA94" alt="Logo TYT" class="w-16 h-16 rounded-full shadow-md object-cover">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900">Trình quản lý Bệnh không lây nhiễm</h1>
                    <p class="text-slate-500 mt-1">Phân tích và theo dõi bệnh nhân Tăng huyết áp & Đái tháo đường</p>
                </div>
            </div>
             <div class="text-right flex-shrink-0">
                <p class="font-semibold text-slate-700">BS.Phạm Hải Linh</p>
                <p class="text-sm text-slate-500">TYT xã Xuân Bắc</p>
            </div>
        </header>

        <!-- Vùng tải tệp lên -->
        <div id="upload-container" class="text-center p-8 border-2 border-dashed border-slate-300 rounded-lg bg-white shadow-sm">
             <i data-lucide="upload-cloud" class="mx-auto h-12 w-12 text-slate-400"></i>
            <h2 class="text-xl font-semibold mt-4 mb-2">Bắt đầu phân tích</h2>
            <p class="text-slate-500 mb-4">Vui lòng tải lên tệp Excel chứa dữ liệu khám bệnh của bạn.</p>
            <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls, .csv">
            <button id="upload-button" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-full transition-colors shadow hover:shadow-lg flex items-center gap-2 mx-auto">
                <i data-lucide="file-up"></i>
                Chọn tệp từ máy tính
            </button>
            <p id="file-name" class="mt-3 text-slate-600"></p>
        </div>

        <!-- Vùng hiển thị chính sau khi tải tệp -->
        <main id="main-content" class="hidden">
            <!-- Thanh điều hướng các tab -->
            <div class="mb-6 bg-white rounded-lg shadow-sm border border-slate-200">
                <nav class="flex flex-wrap space-x-4 sm:space-x-8 px-6" aria-label="Tabs">
                    <button data-tab="dashboard" class="tab-button tab-active py-4 px-1 border-b-2 font-medium text-sm flex items-center gap-2"><i data-lucide="layout-dashboard"></i><span class="hidden sm:inline">Tổng quan</span></button>
                    <button data-tab="report" class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300 flex items-center gap-2"><i data-lucide="file-text"></i><span class="hidden sm:inline">Báo cáo</span></button>
                    <button data-tab="export" class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300 flex items-center gap-2"><i data-lucide="printer"></i><span class="hidden sm:inline">Xuất danh sách</span></button>
                    <button data-tab="all-encounters" class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300 flex items-center gap-2"><i data-lucide="list-filter"></i><span class="hidden sm:inline">Tổng hợp Lượt khám</span></button>
                    <button data-tab="ncd-encounters" class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300 flex items-center gap-2"><i data-lucide="heart-pulse"></i><span class="hidden sm:inline">Quản lý THA/ĐTĐ</span></button>
                    <button data-tab="patients" class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300 flex items-center gap-2"><i data-lucide="users-round"></i><span class="hidden sm:inline">Bệnh nhân</span></button>
                    <button data-tab="history" class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300 flex items-center gap-2"><i data-lucide="calendar-days"></i><span class="hidden sm:inline">Lịch sử</span></button>
                    <button data-tab="reference" class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300 flex items-center gap-2"><i data-lucide="book-marked"></i><span class="hidden sm:inline">Tham chiếu</span></button>
                    <button data-tab="save-load" class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300 flex items-center gap-2"><i data-lucide="save"></i><span class="hidden sm:inline">Lưu & Tải</span></button>
                </nav>
            </div>

            <!-- Nội dung các tab -->
            <div id="tab-content">
                <!-- Tab Tổng quan -->
                 <div id="dashboard-view" class="tab-pane space-y-6">
                    <div class="info-card">
                        <div class="flex items-center justify-center space-x-2" id="dashboard-filters">
                             <button data-filter="all" class="dashboard-filter-btn history-sub-tab-active font-semibold px-4 py-2 rounded-full text-sm transition">Tổng hợp chung</button>
                             <button data-filter="tha" class="dashboard-filter-btn bg-gray-200 text-gray-700 hover:bg-gray-300 font-semibold px-4 py-2 rounded-full text-sm transition">Tăng huyết áp</button>
                             <button data-filter="dtd" class="dashboard-filter-btn bg-gray-200 text-gray-700 hover:bg-gray-300 font-semibold px-4 py-2 rounded-full text-sm transition">Đái tháo đường</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="info-card text-center"><p class="text-sm font-medium text-gray-500">Tổng số bệnh nhân</p><p id="totalNcdPatients" class="text-4xl font-bold text-sky-600">0</p></div>
                        <div class="info-card text-center"><p class="text-sm font-medium text-gray-500">Tổng lượt khám</p><p id="totalNcdVisits" class="text-4xl font-bold text-sky-600">0</p></div>
                        <div class="info-card text-center"><p class="text-sm font-medium text-gray-500">Bệnh nhân mới</p><p id="newNcdPatients" class="text-3xl font-bold text-sky-600">0</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div class="info-card lg:col-span-2"><h3 class="font-bold text-center mb-2">Phân bố giới tính</h3><div class="relative h-64 md:h-72"><canvas id="genderChart"></canvas></div></div>
                        <div class="info-card lg:col-span-3"><h3 class="font-bold text-center mb-2">Phân bố nhóm tuổi</h3><div class="relative h-72"><canvas id="ageChart"></canvas></div></div>
                    </div>
                     <div class="info-card"><h3 class="font-bold text-center mb-2">Xu hướng điều trị theo thời gian</h3><div class="relative h-96"><canvas id="treatmentTrendChart"></canvas></div></div>
                     <div class="info-card"><h3 class="font-bold text-left mb-4 text-xl">Thống kê sử dụng thuốc</h3><div id="meds-stats-container" class="overflow-auto max-h-[60vh]"></div></div>
                 </div>

                <!-- Tab Báo cáo -->
                <div id="report-view" class="tab-pane hidden space-y-6">
                    <div class="info-card">
                        <h2 class="text-xl font-bold mb-4">Tùy chọn Báo cáo</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end">
                            <div>
                                <label for="report-population" class="block text-sm font-medium text-gray-700 mb-1">Dân số xã</label>
                                <input type="number" id="report-population" value="15414" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                            </div>
                            <div>
                                <label for="report-period" class="block text-sm font-medium text-gray-700 mb-1">Chọn kỳ báo cáo</label>
                                <select id="report-period" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                                    <option value="month">Tháng cụ thể</option>
                                    <option value="3months">3 tháng gần nhất</option>
                                    <option value="6months">6 tháng gần nhất</option>
                                    <option value="custom">Tùy chọn ngày</option>
                                </select>
                            </div>
                            <div id="month-selector-container">
                                <label for="report-month" class="block text-sm font-medium text-gray-700 mb-1">Chọn tháng/năm</label>
                                <input type="month" id="report-month" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                            </div>
                            <div id="custom-date-container" class="hidden md:col-span-2 grid grid-cols-2 gap-4">
                                <div>
                                    <label for="report-start-date" class="block text-sm font-medium text-gray-700 mb-1">Từ ngày</label>
                                    <input type="date" id="report-start-date" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                                </div>
                                <div>
                                    <label for="report-end-date" class="block text-sm font-medium text-gray-700 mb-1">Đến ngày</label>
                                    <input type="date" id="report-end-date" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                                </div>
                            </div>
                            <div class="lg:col-start-4">
                                <button id="generate-report-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-md transition-colors flex items-center justify-center gap-2">
                                    <i data-lucide="play"></i>
                                    Tạo Báo cáo
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="report-output" class="space-y-6"></div>
                </div>

                <!-- Tab Xuất danh sách -->
                <div id="export-view" class="tab-pane hidden space-y-6">
                    <div class="info-card">
                        <h2 class="text-xl font-bold mb-4">Tùy chọn Xuất danh sách Bệnh nhân</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Chọn bệnh</label>
                                <div class="space-y-1 mt-2">
                                    <label class="flex items-center"><input type="checkbox" name="export-disease" value="tăng huyết áp" class="form-checkbox h-4 w-4 text-sky-600 rounded focus:ring-sky-500" checked> <span class="ml-2 text-sm text-gray-700">Tăng huyết áp</span></label>
                                    <label class="flex items-center"><input type="checkbox" name="export-disease" value="đái tháo đường" class="form-checkbox h-4 w-4 text-sky-600 rounded focus:ring-sky-500" checked> <span class="ml-2 text-sm text-gray-700">Đái tháo đường</span></label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tình trạng điều trị</label>
                                <div class="space-y-1 mt-2">
                                    <label class="flex items-center"><input type="checkbox" name="export-status" value="tại trạm" class="form-checkbox h-4 w-4 text-sky-600 rounded focus:ring-sky-500" checked> <span class="ml-2 text-sm text-gray-700">Điều trị tại trạm</span></label>
                                    <label class="flex items-center"><input type="checkbox" name="export-status" value="nơi khác" class="form-checkbox h-4 w-4 text-sky-600 rounded focus:ring-sky-500" checked> <span class="ml-2 text-sm text-gray-700">Điều trị nơi khác</span></label>
                                </div>
                            </div>
                            <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                     <label for="export-period" class="block text-sm font-medium text-gray-700 mb-1">Kỳ lập danh sách</label>
                                     <select id="export-period" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                                         <option value="month">Tháng cụ thể</option>
                                         <option value="custom">Tùy chọn ngày</option>
                                     </select>
                                </div>
                                <div id="export-month-selector-container">
                                     <label for="export-month" class="block text-sm font-medium text-gray-700 mb-1">Chọn tháng/năm</label>
                                     <input type="month" id="export-month" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                                </div>
                                <div id="export-custom-date-container" class="hidden sm:col-span-2 grid grid-cols-2 gap-4">
                                     <div>
                                         <label for="export-start-date" class="block text-sm font-medium text-gray-700 mb-1">Từ ngày</label>
                                         <input type="date" id="export-start-date" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                                     </div>
                                     <div>
                                         <label for="export-end-date" class="block text-sm font-medium text-gray-700 mb-1">Đến ngày</label>
                                         <input type="date" id="export-end-date" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                                     </div>
                                </div>
                            </div>
                            <div class="lg:col-start-4 flex items-center">
                                <button id="export-excel-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-md transition-colors flex items-center justify-center gap-2">
                                    <i data-lucide="file-down"></i>
                                    Xuất Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- Tab Tổng hợp Lượt khám -->
                <div id="all-encounters-view" class="tab-pane hidden">
                    <div class="info-card mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <div class="lg:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm chung</label>
                                <input type="text" id="all-encounters-search" placeholder="Tên, địa chỉ, tình trạng, chẩn đoán..." class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                            </div>
                            <div>
                                <label for="all-encounters-month-filter" class="block text-sm font-medium text-gray-700 mb-1">Tháng khám</label>
                                <select id="all-encounters-month-filter" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                                    <option value="all">Tất cả các tháng</option>
                                </select>
                            </div>
                            <button id="all-encounters-reset-filters" class="w-full bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-md transition-colors">Xóa lọc</button>
                        </div>
                        <p id="all-encounters-count" class="text-sm text-slate-500 mt-2"></p>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-lg shadow-sm border">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Ngày khám</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Họ và Tên</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Năm sinh</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tuổi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Giới tính</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider address-col">Địa chỉ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tình trạng</th>
                                </tr>
                            </thead>
                            <tbody id="all-encounters-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Quản lý THA/ĐTĐ -->
                <div id="ncd-encounters-view" class="tab-pane hidden">
                    <div class="info-card mb-4">
                        <h3 class="font-bold text-lg mb-4">Bộ lọc chi tiết</h3>
                        <div id="ncd-filters" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end">
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm</label>
                                <input type="text" id="ncd-encounters-search" placeholder="Theo tên, địa chỉ..." class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tháng khám</label>
                                <select id="ncd-month-filter" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                                    <option value="all">Tất cả các tháng</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Năm sinh</label>
                                <input type="number" id="ncd-birthyear-filter" placeholder="VD: 1965" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Giới tính</label>
                                <select id="ncd-gender-filter" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                                    <option value="all">Tất cả</option>
                                    <option value="Nam">Nam</option>
                                    <option value="Nữ">Nữ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bệnh lý</label>
                                <div class="space-y-1">
                                    <label class="flex items-center"><input type="checkbox" name="ncd-disease-filter" value="tăng huyết áp" class="form-checkbox h-4 w-4 text-sky-600 rounded focus:ring-sky-500"> <span class="ml-2 text-sm text-gray-700">Tăng huyết áp</span></label>
                                    <label class="flex items-center"><input type="checkbox" name="ncd-disease-filter" value="đái tháo đường" class="form-checkbox h-4 w-4 text-sky-600 rounded focus:ring-sky-500"> <span class="ml-2 text-sm text-gray-700">Đái tháo đường</span></label>
                                </div>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tình trạng</label>
                                <div class="space-y-1">
                                    <label class="flex items-center"><input type="checkbox" name="ncd-status-filter" value="tại trạm" class="form-checkbox h-4 w-4 text-sky-600 rounded focus:ring-sky-500"> <span class="ml-2 text-sm text-gray-700">Điều trị tại trạm</span></label>
                                    <label class="flex items-center"><input type="checkbox" name="ncd-status-filter" value="nơi khác" class="form-checkbox h-4 w-4 text-sky-600 rounded focus:ring-sky-500"> <span class="ml-2 text-sm text-gray-700">Điều trị nơi khác</span></label>
                                </div>
                            </div>
                            <div class="lg:col-start-4">
                               <button id="ncd-reset-filters" class="w-full bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-md transition-colors">Xóa bộ lọc</button>
                            </div>
                        </div>
                        <p id="ncd-encounters-count" class="text-sm text-slate-500 mt-4"></p>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-lg shadow-sm border">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Ngày khám</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Họ và Tên</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Năm sinh</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tuổi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Giới tính</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider address-col">Địa chỉ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tình trạng</th>
                                </tr>
                            </thead>
                            <tbody id="ncd-encounters-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Danh sách bệnh nhân -->
                <div id="patients-view" class="tab-pane hidden">
                    <div class="info-card mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <div class="lg:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm theo Tên, Địa chỉ</label>
                                <input type="text" id="patients-search" placeholder="Nhập từ khóa..." class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                            </div>
                            <div>
                                <label for="patients-month-filter" class="block text-sm font-medium text-gray-700 mb-1">Khám trong tháng</label>
                                <select id="patients-month-filter" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                                    <option value="all">Tất cả các tháng</option>
                                </select>
                            </div>
                            <button id="patients-reset-filters" class="w-full bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-md transition-colors">Xóa lọc</button>
                        </div>
                        <p id="patients-count" class="text-sm text-slate-500 mt-2"></p>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-lg shadow-sm border">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Họ và Tên</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Năm sinh</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Giới tính</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider address-col">Địa chỉ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Khám gần nhất</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tổng số lần khám</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Số lần điều trị tại trạm</th>
                                </tr>
                            </thead>
                            <tbody id="patients-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Lịch sử điều trị -->
                <div id="history-view" class="tab-pane hidden">
                    <div class="info-card">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <div id="history-filters" class="flex flex-col sm:flex-row flex-wrap gap-4 items-start sm:items-center">
                                 <input type="text" id="history-search" placeholder="Tìm theo tên bệnh nhân..." class="p-2 border border-slate-300 rounded-md md:w-auto w-full focus:ring-sky-500 focus:border-sky-500">
                                <div class="flex items-center space-x-4">
                                    <h4 class="font-semibold text-sm">Bệnh:</h4>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="disease" value="tha" class="form-checkbox h-4 w-4 text-sky-600 rounded focus:ring-sky-500"><span>THA</span></label>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="disease" value="dtd" class="form-checkbox h-4 w-4 text-sky-600 rounded focus:ring-sky-500"><span>ĐTĐ</span></label>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <h4 class="font-semibold text-sm">Tình trạng:</h4>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="status" value="tai tram" class="form-checkbox h-4 w-4 text-sky-600 rounded focus:ring-sky-500"><span>Tại trạm</span></label>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="status" value="noi khac" class="form-checkbox h-4 w-4 text-sky-600 rounded focus:ring-sky-500"><span>Nơi khác</span></label>
                                </div>
                            </div>
                            <p id="history-count" class="text-sm text-slate-500 flex-shrink-0"></p>
                        </div>

                        <div class="bg-gray-100 p-2 rounded-lg inline-flex space-x-1 mb-4" id="history-sub-tabs">
                           <button data-mode="C" class="history-sub-tab history-sub-tab-active font-semibold px-3 py-1.5 rounded-md text-sm transition">Có ghi nhận</button>
                           <button data-mode="M" class="history-sub-tab bg-transparent text-gray-600 hover:bg-gray-200 font-semibold px-3 py-1.5 rounded-md text-sm transition">Mới ghi nhận</button>
                           <button data-mode="B" class="history-sub-tab bg-transparent text-gray-600 hover:bg-gray-200 font-semibold px-3 py-1.5 rounded-md text-sm transition">Bỏ ghi nhận</button>
                           <button data-mode="Q" class="history-sub-tab bg-transparent text-gray-600 hover:bg-gray-200 font-semibold px-3 py-1.5 rounded-md text-sm transition">Quay lại</button>
                           <button data-mode="QL" class="history-sub-tab bg-transparent text-gray-600 hover:bg-gray-200 font-semibold px-3 py-1.5 rounded-md text-sm transition">Đang quản lý</button>
                        </div>

                        <div id="history-table-container" class="overflow-auto border border-slate-200 rounded-lg max-h-[70vh]"></div>
                    </div>
                </div>
                
                 <!-- Tab Điều trị tham chiếu -->
                <div id="reference-view" class="tab-pane hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="info-card">
                            <h3 class="text-lg font-bold text-slate-800 mb-4">Danh mục thuốc Tăng huyết áp</h3>
                            <p class="text-sm text-slate-500 mb-3">Thêm tên thuốc hoặc hoạt chất (viết liền, không dấu) để ứng dụng nhận diện. Nhấn Enter để thêm.</p>
                            <div id="tha-meds-container"></div>
                        </div>
                        <div class="info-card">
                            <h3 class="text-lg font-bold text-slate-800 mb-4">Danh mục thuốc Đái tháo đường</h3>
                             <p class="text-sm text-slate-500 mb-3">Thêm tên thuốc hoặc hoạt chất (viết liền, không dấu) để ứng dụng nhận diện. Nhấn Enter để thêm.</p>
                            <div id="dtd-meds-container"></div>
                        </div>
                    </div>
                </div>

                <!-- Tab Lưu & Tải -->
                <div id="save-load-view" class="tab-pane hidden space-y-6">
                    <div class="info-card">
                        <h2 class="text-xl font-bold mb-4">Lưu trữ & Khôi phục Dữ liệu</h2>
                        <p class="text-slate-600 mb-6">Chức năng này cho phép bạn xuất ra một file Excel chứa toàn bộ dữ liệu khám bệnh cùng với các ghi chú và tình trạng bệnh nhân (tử vong/chuyển đi) mà bạn đã nhập. File này có thể được tải lên lại để khôi phục trạng thái làm việc.</p>
                        <div class="p-4 border-l-4 border-amber-400 bg-amber-50 mb-6">
                            <h4 class="font-bold text-amber-800">Quan trọng!</h4>
                            <p class="text-sm text-amber-700">Hãy xuất và lưu file này thường xuyên để tránh mất dữ liệu khi bạn làm mới hoặc đóng trình duyệt. Đây là cách duy nhất để lưu lại các ghi chú và cập nhật tình trạng bệnh nhân.</p>
                        </div>
                        <button id="export-save-data-btn" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-md transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="download"></i>
                            Xuất file Excel để lưu trữ
                        </button>
                        <p id="export-save-status" class="text-sm mt-2"></p>
                    </div>
                </div>

            </div>
        </main>
        
        <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden z-50">
            <div class="flex items-center space-x-3"><svg class="animate-spin h-8 w-8 text-sky-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="text-lg font-medium text-slate-700">Đang phân tích dữ liệu...</span></div>
        </div>

        <div id="detail-modal" class="modal fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none z-40">
            <div class="modal-content bg-slate-100 rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] transform scale-95 flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-slate-200 flex-shrink-0 bg-white rounded-t-lg">
                    <h3 id="modal-title" class="text-xl font-bold text-slate-900">Chi tiết Bệnh nhân</h3>
                    <button id="close-modal-button" class="text-slate-400 hover:text-slate-600 text-3xl leading-none">&times;</button>
                </div>
                <div id="modal-body" class="overflow-y-auto flex-grow p-4"></div>
                <div class="p-4 bg-slate-200 border-t border-slate-300 text-right rounded-b-lg flex-shrink-0">
                    <button id="close-modal-button-footer" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg text-sm">Đóng</button>
                </div>
            </div>
        </div>
        
        <div id="alerts-container" class="fixed top-5 right-5 z-50 space-y-3"></div>

        <footer class="fixed bottom-4 right-8 z-50">
            <p style="font-family: 'Dancing Script', cursive;" class="text-2xl font-bold text-slate-600 select-none">Dr.Liph</p>
        </footer>
    </div>

    <script>
        // --- KHỞI TẠO VÀ DOM ELEMENTS ---
        const uploadContainer = document.getElementById('upload-container');
        const uploadButton = document.getElementById('upload-button');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name');
        const mainContent = document.getElementById('main-content');
        const loadingOverlay = document.getElementById('loading-overlay');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const modal = document.getElementById('detail-modal');
        const modalBody = document.getElementById('modal-body');
        const modalTitle = document.getElementById('modal-title');
        const closeModalButtons = [document.getElementById('close-modal-button'), document.getElementById('close-modal-button-footer')];
        let chartInstances = {};
        
        let appState = {
            isDirty: false, // Flag to check if data has been modified (notes, status)
            rawData: [],
            rawHeaders: [],
            headerRowIndex: -1,
            encounters: [],
            patients: {},
            activeTab: 'dashboard',
            dashboardFilter: 'all',
            historySubTab: 'C',
            thaMeds: [],
            dtdMeds: [],
            filters: {
                allEncounters: { searchText: '', month: 'all' },
                ncdEncounters: { 
                    searchText: '',
                    month: 'all',
                    birthYear: '',
                    gender: 'all',
                    diseases: [],
                    statuses: []
                },
                patients: { searchText: '', month: 'all' },
                history: { searchText: '', diseases: [], statuses: [] }
            },
            currentPatientId: null
        };

        const DEFAULT_THA_MEDS = ['amlodipin', 'nifedipin', 'losartan', 'telmisartan', 'irbesartan', 'valsartan', 'candesartan', 'perindopril', 'enalapril', 'lisinopril', 'ramipril', 'metoprolol', 'bisoprolol', 'carvedilol', 'atenolol', 'hydrochlorothiazide', 'indapamide', 'furosemide', 'spironolactone', 'coveram', 'coversyl', 'amlodac', 'amcardia', 'cozaar', 'diovan', 'micardis', 'aprovel', 'atacand', 'renitec', 'zestril', 'concor', 'betaloc', 'dilatrend', 'tenormin', 'lasix', 'aldan'];
        const DEFAULT_DTD_MEDS = ['metformin', 'gliclazide', 'glimepiride', 'glibenclamide', 'sitagliptin', 'vildagliptin', 'saxagliptin', 'linagliptin', 'dapagliflozin', 'empagliflozin', 'canagliflozin', 'pioglitazone', 'acarbose', 'diamicron', 'glucophage', 'amaryl', 'daonil', 'januvia', 'galvus', 'onglyza', 'trajenta', 'forxiga', 'jardiance', 'invokana', 'actos', 'glucobay', 'tforilex', 'glumeron', 'golddicron', 'dhmetglu', 'gliclada', 'gludipha'];
        const CHUYEN_VIEN_KEYWORDS = ['chuyển viện', 'chuyển đến bệnh viện'];

        const COLUMN_MAPPINGS = {
            ngayKham: ['ngay kham', 'ngày khám'],
            hoTen: ['họ và tên', 'họ tên', 'hoten'],
            namSinh: ['năm sinh', 'namsinh', 'ns', 'ngày tháng năm sinh'],
            gioiTinh: ['giới', 'giới tính', 'gioi'],
            diaChi: ['địa chỉ', 'diachi'],
            trieuChung: ['triệu chứng', 'trieuchung'],
            chanDoan: ['chẩn đoán', 'chandoan'],
            dieuTri: ['phương pháp điều trị', 'dieu tri', 'điều trị'],
            cccd: ['đdcn/ giấy tờ tùy thân', 'cccd'],
            bhyt: ['số thẻ bhyt'],
            // New columns for data persistence
            note: ['ghi chú', 'ghichu'],
            ngayTuVong: ['ngày tử vong', 'ngay tuvong'],
            ngayChuyenDi: ['ngày chuyển đi', 'ngay chuyendi']
        };
        
        function showAlert(message, type = 'info', duration = 5000) {
            const container = document.getElementById('alerts-container');
            const alertId = `alert-${Date.now()}`;
            
            const colors = {
                info: 'bg-blue-100 border-blue-400 text-blue-700',
                success: 'bg-green-100 border-green-400 text-green-700',
                warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
                error: 'bg-red-100 border-red-400 text-red-700',
            };

            const alertDiv = document.createElement('div');
            alertDiv.id = alertId;
            alertDiv.className = `border px-4 py-3 rounded relative shadow-lg ${colors[type]}`;
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `<span class="block sm:inline">${message}</span>`;
            
            container.appendChild(alertDiv);

            setTimeout(() => {
                const el = document.getElementById(alertId);
                if (el) {
                    el.style.opacity = '0';
                    el.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => el.remove(), 500);
                }
            }, duration);
        }

        function findHeaderRow(rows) {
            const keywords = ['họ và tên', 'giới tính', 'địa chỉ', 'chẩn đoán', 'sinh', 'triệu chứng'];
            let bestMatchIndex = -1, maxScore = 0;
            
            rows.slice(0, 10).forEach((row, index) => {
                if (!Array.isArray(row) || row.length < 5) return;
                const lowerRow = row.join(';').toLowerCase();
                let score = 0;
                keywords.forEach(kw => { if (lowerRow.includes(kw)) score++; });
                if (score > maxScore) { 
                    maxScore = score; 
                    bestMatchIndex = index; 
                }
            });
            return maxScore >= 3 ? bestMatchIndex : -1;
        }

        function normalizeDate(dateValue) {
            if (!dateValue) return null;
            if (dateValue instanceof Date) return dateValue;
             if (typeof dateValue === 'number') {
                const date = new Date(Math.round((dateValue - 25569) * 86400 * 1000));
                 // Adjust for timezone offset to get correct UTC date
                return new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
            }
            if (typeof dateValue === 'string') {
                // Try parsing dd/mm/yyyy or dd.mm.yyyy
                const parts = dateValue.match(/(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{2,4})/);
                if (parts) {
                    const day = parseInt(parts[1], 10);
                    const month = parseInt(parts[2], 10);
                    let year = parseInt(parts[3], 10);
                     if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                        if (year < 100) year += 2000;
                        // Use UTC to avoid timezone issues during parsing
                        const date = new Date(Date.UTC(year, month - 1, day));
                        if (date.getUTCFullYear() === year && date.getUTCMonth() === month - 1 && date.getUTCDate() === day) {
                            return date;
                        }
                    }
                }
            }
            // Fallback for other string formats like ISO
            const parsedDate = new Date(dateValue);
            return isNaN(parsedDate.getTime()) ? null : parsedDate;
        }

        function formatDate(date, format = 'dd/mm/yyyy') {
            if (!date || !(date instanceof Date) || isNaN(date)) return 'N/A';
            if (format === 'yyyy-mm-dd') {
                return date.toISOString().split('T')[0];
            }
            return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        function calculateAge(birthYear, encounterDate) {
            if (!birthYear || !encounterDate || isNaN(parseInt(birthYear))) return 'N/A';
            return encounterDate.getFullYear() - parseInt(birthYear);
        }

        function extractVitals(symptoms) {
            if (typeof symptoms !== 'string') return {};
            const vitals = {};
            const patterns = {
                'Huyết áp': /huyết áp:?\s*(\d{2,3}\s*\/\s*\d{2,3})/i,
                'Mạch': /mạch:?\s*(\d{2,3})/i,
                'Nhiệt độ': /nhiệt độ:?\s*(\d{2}(\.\d)?)/i,
                'Nhịp thở': /nhịp thở:?\s*(\d{2})/i,
                'Cân nặng': /cân nặng:?\s*(\d{2,3}(\.\d)?)/i,
                'Chiều cao': /chiều cao:?\s*(\d{2,3})/i,
            };
            for (const key in patterns) {
                const match = symptoms.match(patterns[key]);
                vitals[key] = match ? match[1].trim() : 'N/A';
            }
            return vitals;
        }
        
        function cleanSymptomsString(symptoms) {
            if (typeof symptoms !== 'string') return 'N/A';
            let cleaned = symptoms;
            const patterns = [
                /huyết áp:?\s*(\d{2,3}\s*\/\s*\d{2,3})/ig,
                /mạch:?\s*(\d{2,3})/ig,
                /nhiệt độ:?\s*(\d{2}(\.\d)?)/ig,
                /nhịp thở:?\s*(\d{2})/ig,
                /cân nặng:?\s*(\d{2,3}(\.\d)?)/ig,
                /chiều cao:?\s*(\d{2,3})/ig,
            ];
            patterns.forEach(p => {
                cleaned = cleaned.replace(p, '');
            });
            cleaned = cleaned.replace(/[,;]\s*[,;]/g, ',').replace(/^\s*[,;]\s*|\s*[,;]\s*$/g, '').trim();
            return cleaned || 'Không có';
        }

        function determineStatus(encounter) {
            const statuses = [];
            const dieuTriLower = (encounter.dieuTri || '').toLowerCase().replace(/[\s\W]/g, '');
            const chanDoanLower = (encounter.chanDoan || '').toLowerCase();
            
            const hasTHAMeds = appState.thaMeds.some(k => dieuTriLower.includes(k));
            const hasDTDMeds = appState.dtdMeds.some(k => dieuTriLower.includes(k));
            const isChuyenVien = CHUYEN_VIEN_KEYWORDS.some(k => (encounter.dieuTri || '').toLowerCase().includes(k)) || !(encounter.dieuTri || '').trim();
            
            if (hasTHAMeds) {
                statuses.push('Tăng huyết áp điều trị tại trạm');
            } else if (chanDoanLower.includes('tăng huyết áp') && isChuyenVien) {
                statuses.push('Tăng huyết áp điều trị nơi khác');
            }

            if (hasDTDMeds) {
                statuses.push('Đái tháo đường điều trị tại trạm');
            } else if ((chanDoanLower.includes('đái tháo đường') || chanDoanLower.includes('tiểu đường')) && isChuyenVien) {
                statuses.push('Đái tháo đường điều trị nơi khác');
            }
            
            return statuses.length > 0 ? statuses.join('; ') : 'Không xác định';
        }

        function processData(jsonData) {
            appState.patients = {};
            appState.headerRowIndex = findHeaderRow(jsonData);
            if (appState.headerRowIndex === -1) {
                console.error("Could not find a valid header row.");
                showAlert("Lỗi: Không tìm thấy dòng tiêu đề hợp lệ trong file Excel.", "error");
                return;
            }

            appState.rawHeaders = jsonData[appState.headerRowIndex];
            const headers = appState.rawHeaders.map(h => String(h || '').toLowerCase().trim());
            const dataRows = jsonData.slice(appState.headerRowIndex + 1);

            const headerMap = {};
            for (const key in COLUMN_MAPPINGS) {
                const aliases = COLUMN_MAPPINGS[key];
                const foundIndex = headers.findIndex(h => aliases.some(alias => h.includes(alias)));
                if (foundIndex !== -1) headerMap[key] = foundIndex;
            }

            let currentDate = null;
            let encountersList = [];
            let encounterIdCounter = 0;

            dataRows.forEach((row, rowIndex) => {
                if (!row || !Array.isArray(row) || row.every(cell => !cell)) return;

                const firstCell = String(row[0] || '').trim();
                const dateMatch = firstCell.match(/^ngày\s+(\d{1,2}[\/\.-]\d{1,2}[\/\.-]\d{2,4})/i);

                if (dateMatch) {
                    currentDate = normalizeDate(dateMatch[1]);
                    return;
                }
                
                const hoTen = row[headerMap.hoTen];
                const namSinh = row[headerMap.namSinh];

                if (!hoTen || !namSinh) return;

                const encounter = { 
                    id: `enc-${encounterIdCounter++}`,
                    originalRowIndex: appState.headerRowIndex + 1 + rowIndex // Store original position
                };

                for (const key in headerMap) {
                    encounter[key] = row[headerMap[key]];
                }
                
                encounter.ngayKhamDate = normalizeDate(encounter.ngayKham) || currentDate;
                const namSinhClean = String(namSinh).split(/[\/\.-]/).pop().trim();
                encounter.namSinhNum = parseInt(namSinhClean, 10);

                if (!encounter.hoTen || !encounter.namSinhNum || isNaN(encounter.namSinhNum) || !encounter.ngayKhamDate) return;

                encounter.tuoi = calculateAge(encounter.namSinhNum, encounter.ngayKhamDate);
                encounter.vitals = extractVitals(encounter.trieuChung);
                encounter.tinhTrang = determineStatus(encounter);

                const patientId = `${String(encounter.hoTen).trim()}_${encounter.namSinhNum}`;
                if (!appState.patients[patientId]) {
                    appState.patients[patientId] = {
                        id: patientId, hoTen: String(encounter.hoTen).trim(), namSinh: encounter.namSinhNum,
                        status: 'active', statusDate: null,
                        encounters: []
                    };
                }
                appState.patients[patientId].encounters.push(encounter);
                encountersList.push(encounter);
            });

            // Second pass to populate patient-level data from saved file (tử vong, chuyển đi)
            if (headerMap.ngayTuVong || headerMap.ngayChuyenDi) {
                 encountersList.forEach(encounter => {
                    const patientId = `${String(encounter.hoTen).trim()}_${encounter.namSinhNum}`;
                    const patient = appState.patients[patientId];
                    if (!patient) return;
                    
                    const ngayTuVong = normalizeDate(encounter.ngayTuVong);
                    if (ngayTuVong && (!patient.statusDate || ngayTuVong > patient.statusDate)) {
                        patient.status = 'deceased';
                        patient.statusDate = ngayTuVong;
                    }

                    const ngayChuyenDi = normalizeDate(encounter.ngayChuyenDi);
                    if (ngayChuyenDi && (!patient.statusDate || ngayChuyenDi > patient.statusDate)) {
                        patient.status = 'transferred';
                        patient.statusDate = ngayChuyenDi;
                    }
                 });
            }

            Object.values(appState.patients).forEach(p => {
                p.encounters.sort((a, b) => b.ngayKhamDate - a.ngayKhamDate);
                if(p.encounters.length > 0) {
                    p.gioiTinh = p.encounters[0].gioiTinh;
                    p.diaChi = p.encounters[0].diaChi;
                }
                // Validation check
                if (p.status !== 'active' && p.statusDate) {
                    const invalidEncounter = p.encounters.find(e => e.ngayKhamDate > p.statusDate);
                    if(invalidEncounter) {
                        const statusText = p.status === 'deceased' ? 'tử vong' : 'chuyển đi';
                        showAlert(`Cảnh báo: Bệnh nhân <b>${p.hoTen}</b> có lượt khám vào ngày ${formatDate(invalidEncounter.ngayKhamDate)} sau ngày ghi nhận ${statusText} (${formatDate(p.statusDate)}). Vui lòng kiểm tra lại dữ liệu.`, 'warning', 10000);
                    }
                }
            });

            appState.encounters = encountersList.sort((a, b) => b.ngayKhamDate - a.ngayKhamDate);
            appState.isDirty = false; // Reset dirty flag after loading new data
        }
        
        function renderAllViews() {
            populateAllMonthFilters();
            renderDashboard();
            renderReportView();
            renderExportView();
            renderAllEncountersView();
            renderNcdEncountersView();
            renderPatientsView();
            renderHistoryView();
            renderReferenceView();
        }

        function renderDashboard() {
            const filter = appState.dashboardFilter;
            const encounters = appState.encounters.filter(e => {
                const statusLower = e.tinhTrang.toLowerCase();
                if (filter === 'tha') return statusLower.includes('tăng huyết áp');
                if (filter === 'dtd') return statusLower.includes('đái tháo đường');
                return statusLower.includes('tăng huyết áp') || statusLower.includes('đái tháo đường');
            });
            const patientIds = new Set(encounters.map(e => `${e.hoTen.trim()}_${e.namSinhNum}`));
            const patients = Array.from(patientIds).map(id => appState.patients[id]).filter(Boolean);
            
            const firstVisitMonths = {};
            patients.forEach(p => {
                const firstVisit = p.encounters[p.encounters.length-1];
                const monthKey = `${firstVisit.ngayKhamDate.getFullYear()}-${firstVisit.ngayKhamDate.getMonth()}`;
                if(!firstVisitMonths[p.id]) firstVisitMonths[p.id] = monthKey;
            });
            const newPatientsCount = patients.filter(p => {
                const firstVisit = p.encounters[p.encounters.length-1];
                const currentMonth = new Date();
                return firstVisit.ngayKhamDate.getFullYear() === currentMonth.getFullYear() && firstVisit.ngayKhamDate.getMonth() === currentMonth.getMonth();
            }).length;


            document.getElementById('totalNcdPatients').textContent = patients.length;
            document.getElementById('totalNcdVisits').textContent = encounters.length;
            document.getElementById('newNcdPatients').textContent = newPatientsCount;

            const genderData = { 'Nam': 0, 'Nữ': 0, 'Khác': 0 };
            const ageGroups = { 'Dưới 40': 0, '40-60': 0, 'Trên 60': 0 };
            
            patients.forEach(p => {
                const gender = p.gioiTinh ? p.gioiTinh.toLowerCase() : 'khác';
                if (gender === 'nam') genderData.Nam++;
                else if (gender === 'nữ') genderData.Nữ++;
                else genderData.Khác++;

                const age = new Date().getFullYear() - p.namSinh;
                if (age < 40) ageGroups['Dưới 40']++;
                else if (age <= 60) ageGroups['40-60']++;
                else ageGroups['Trên 60']++;
            });

            const trendData = {};
            encounters.forEach(e => {
                const monthKey = e.ngayKhamDate.toLocaleString('vi-VN', { month: '2-digit', year: 'numeric' });
                if (!trendData[monthKey]) trendData[monthKey] = { taiTram: 0, noiKhac: 0 };
                if (e.tinhTrang.includes('tại trạm')) trendData[monthKey].taiTram++;
                if (e.tinhTrang.includes('nơi khác')) trendData[monthKey].noiKhac++;
            });
            
            const sortedMonths = Object.keys(trendData).sort((a,b) => {
                const [mA, yA] = a.split('/');
                const [mB, yB] = b.split('/');
                return new Date(yA, mA - 1) - new Date(yB, mB-1);
            }).reverse();

            const medsStats = {};
            const medList = filter === 'tha' ? appState.thaMeds : (filter === 'dtd' ? appState.dtdMeds : [...appState.thaMeds, ...appState.dtdMeds]);
            encounters.forEach(e => {
                const dieuTriLower = (e.dieuTri || '').toLowerCase();
                const monthKey = e.ngayKhamDate.toLocaleString('vi-VN', { month: '2-digit', year: 'numeric' });

                medList.forEach(med => {
                    if (dieuTriLower.includes(med)) {
                         if (!medsStats[med]) medsStats[med] = { total: 0, months: {} };
                         const match = dieuTriLower.match(new RegExp(med + '[^x]*x\\s*(\\d+)'));
                         const quantity = match ? parseInt(match[1], 10) : 0;
                         medsStats[med].total += quantity;
                         medsStats[med].months[monthKey] = (medsStats[med].months[monthKey] || 0) + quantity;
                    }
                });
            });
            const sortedMeds = Object.entries(medsStats).sort(([,a], [,b]) => b.total - a.total);
            
            const medsContainer = document.getElementById('meds-stats-container');
            if(sortedMeds.length === 0){
                 medsContainer.innerHTML = `<p class="text-center text-slate-500 py-4">Không có dữ liệu thuốc để hiển thị cho lựa chọn này.</p>`;
            } else {
                 let medsTableHtml = `<table class="min-w-full text-sm">
                    <thead class="bg-slate-50 sticky top-0 z-20"><tr>
                        <th class="px-4 py-2 text-left font-semibold sticky-col">Tên thuốc</th>
                        <th class="px-4 py-2 text-center font-semibold">Tổng cộng</th>`;
                 sortedMonths.forEach(m => medsTableHtml += `<th class="px-4 py-2 text-center font-semibold">${m}</th>`);
                 medsTableHtml += `</tr></thead><tbody class="divide-y divide-slate-100">`;
                 sortedMeds.forEach(([med, data]) => {
                    medsTableHtml += `<tr><td class="px-4 py-2 font-medium sticky-col">${med}</td><td class="px-4 py-2 text-center font-bold">${data.total}</td>`;
                    sortedMonths.forEach(m => {
                        medsTableHtml += `<td class="px-4 py-2 text-center">${data.months[m] || 0}</td>`;
                    });
                    medsTableHtml += `</tr>`;
                 });
                 medsTableHtml += `</tbody></table>`;
                 medsContainer.innerHTML = medsTableHtml;
            }

            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances.gender = new Chart(document.getElementById('genderChart'), { type: 'doughnut', data: { labels: Object.keys(genderData), datasets: [{ data: Object.values(genderData), backgroundColor: ['#3b82f6', '#ec4899', '#a855f7'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false } });
            chartInstances.age = new Chart(document.getElementById('ageChart'), { type: 'bar', data: { labels: Object.keys(ageGroups), datasets: [{ label: 'Số lượng bệnh nhân', data: Object.values(ageGroups), backgroundColor: '#34d399' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
            chartInstances.trend = new Chart(document.getElementById('treatmentTrendChart'), { type: 'line', data: { labels: sortedMonths, datasets: [{ label: 'Tại trạm', data: sortedMonths.map(m => trendData[m].taiTram), borderColor: '#0ea5e9', tension: 0.1, fill: false }, { label: 'Nơi khác', data: sortedMonths.map(m => trendData[m].noiKhac), borderColor: '#f97316', tension: 0.1, fill: false }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
        }

        function renderReportView() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('report-month').value = `${year}-${month}`;
            document.getElementById('report-end-date').valueAsDate = now;
            const oneMonthAgo = new Date(now);
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            document.getElementById('report-start-date').valueAsDate = oneMonthAgo;
        }

        function renderExportView() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('export-month').value = `${year}-${month}`;
            document.getElementById('export-end-date').valueAsDate = now;
            const oneMonthAgo = new Date(now);
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            document.getElementById('export-start-date').valueAsDate = oneMonthAgo;
        }

        function renderAllEncountersView() {
            const tableBody = document.getElementById('all-encounters-table-body');
            const { searchText, month } = appState.filters.allEncounters;

            const filteredEncounters = appState.encounters.filter(e => {
                const searchString = `${e.hoTen || ''} ${e.diaChi || ''} ${e.tinhTrang || ''} ${e.chanDoan || ''}`.toLowerCase();
                const searchTextMatch = searchString.includes(searchText.toLowerCase());
                const monthMatch = month === 'all' || (e.ngayKhamDate && `${e.ngayKhamDate.getFullYear()}-${String(e.ngayKhamDate.getMonth() + 1).padStart(2, '0')}` === month);
                return searchTextMatch && monthMatch;
            });
            
            tableBody.innerHTML = filteredEncounters.map(e => {
                const isTaiTram = e.tinhTrang.includes('tại trạm');
                const isNoiKhac = e.tinhTrang.includes('nơi khác');
                let rowClass = '';
                if (isTaiTram) rowClass = 'bg-sky-50/50';
                else if (isNoiKhac) rowClass = 'bg-amber-50/50';

                return `<tr class="${rowClass} hover:bg-slate-100 cursor-pointer" onclick="showDetailModal('${e.hoTen.trim()}_${e.namSinhNum}', '${e.id}')">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800">${formatDate(e.ngayKhamDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${e.hoTen}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800">${e.namSinhNum}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800">${e.tuoi}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800">${e.gioiTinh}</td>
                    <td class="px-6 py-4 text-sm text-slate-800 address-col">${e.diaChi || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800">${e.tinhTrang}</td>
                </tr>`;
            }).join('');

            document.getElementById('all-encounters-count').textContent = `Hiển thị ${filteredEncounters.length} trên tổng số ${appState.encounters.length} lượt khám.`;
        }
        
        function populateAllMonthFilters() {
            const monthFilters = document.querySelectorAll('#ncd-month-filter, #all-encounters-month-filter, #patients-month-filter');
            const encounterMonths = new Set();
            appState.encounters.forEach(e => {
                if(e.ngayKhamDate) {
                    const monthKey = `${e.ngayKhamDate.getFullYear()}-${String(e.ngayKhamDate.getMonth() + 1).padStart(2, '0')}`;
                    encounterMonths.add(monthKey);
                }
            });

            const sortedMonths = Array.from(encounterMonths).sort((a,b) => b.localeCompare(a));
            
            monthFilters.forEach(filter => {
                // Clear existing options except the first one
                while (filter.options.length > 1) {
                    filter.remove(1);
                }
                
                sortedMonths.forEach(monthKey => {
                    const [year, month] = monthKey.split('-');
                    const option = document.createElement('option');
                    option.value = monthKey;
                    option.textContent = `Tháng ${month}/${year}`;
                    filter.appendChild(option);
                });
            });
        }
        
        function renderNcdEncountersView() {
            const tableBody = document.getElementById('ncd-encounters-table-body');
            const filters = appState.filters.ncdEncounters;
            const ncdEncounters = appState.encounters.filter(e => e.tinhTrang.toLowerCase() !== 'không xác định');

            const filteredEncounters = ncdEncounters.filter(e => {
                const statusLower = e.tinhTrang.toLowerCase();
                const searchString = `${e.hoTen || ''} ${e.diaChi || ''}`.toLowerCase();

                const searchTextMatch = !filters.searchText || searchString.includes(filters.searchText.toLowerCase());
                const monthMatch = filters.month === 'all' || (e.ngayKhamDate && `${e.ngayKhamDate.getFullYear()}-${String(e.ngayKhamDate.getMonth() + 1).padStart(2, '0')}` === filters.month);
                const birthYearMatch = !filters.birthYear || e.namSinhNum == filters.birthYear;
                const genderMatch = filters.gender === 'all' || (e.gioiTinh && e.gioiTinh.toLowerCase() === filters.gender.toLowerCase());
                const diseaseMatch = filters.diseases.length === 0 || filters.diseases.some(d => statusLower.includes(d));
                const statusMatch = filters.statuses.length === 0 || filters.statuses.some(s => statusLower.includes(s));

                return searchTextMatch && monthMatch && birthYearMatch && genderMatch && diseaseMatch && statusMatch;
            });

            tableBody.innerHTML = filteredEncounters.map(e => {
                const isTaiTram = e.tinhTrang.includes('tại trạm');
                let rowClass = isTaiTram ? 'bg-sky-50/50' : 'bg-amber-50/50';

                return `<tr class="${rowClass} hover:bg-slate-100 cursor-pointer" onclick="showDetailModal('${e.hoTen.trim()}_${e.namSinhNum}', '${e.id}')">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800">${formatDate(e.ngayKhamDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${e.hoTen}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800">${e.namSinhNum}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800">${e.tuoi}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800">${e.gioiTinh}</td>
                    <td class="px-6 py-4 text-sm text-slate-800 address-col">${e.diaChi || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800">${e.tinhTrang}</td>
                </tr>`;
            }).join('');

            document.getElementById('ncd-encounters-count').textContent = `Tìm thấy ${filteredEncounters.length} trên tổng số ${ncdEncounters.length} lượt khám THA/ĐTĐ.`;
        }

        function renderPatientsView() {
            const tableBody = document.getElementById('patients-table-body');
            const { searchText, month } = appState.filters.patients;
            const ncdPatients = Object.values(appState.patients).filter(p => p.encounters.some(e => e.tinhTrang !== 'Không xác định'));
            
            const filteredPatients = ncdPatients.filter(p => {
                const searchTextMatch = `${p.hoTen || ''} ${p.diaChi || ''}`.toLowerCase().includes(searchText.toLowerCase());
                const monthMatch = month === 'all' || p.encounters.some(e => e.ngayKhamDate && `${e.ngayKhamDate.getFullYear()}-${String(e.ngayKhamDate.getMonth() + 1).padStart(2, '0')}` === month);
                return searchTextMatch && monthMatch;
            });

            tableBody.innerHTML = filteredPatients.map(p => {
                const latestEncounter = p.encounters[0];
                const atStationCount = p.encounters.filter(e => e.tinhTrang.includes('tại trạm')).length;
                
                let statusIndicator = '';
                if (p.status === 'deceased') {
                    statusIndicator = '<span class="ml-2 text-xs font-bold text-red-600">(TỬ VONG)</span>';
                } else if (p.status === 'transferred') {
                    statusIndicator = '<span class="ml-2 text-xs font-bold text-orange-600">(CHUYỂN ĐI)</span>';
                }

                return `<tr class="hover:bg-slate-100 cursor-pointer" onclick="showDetailModal('${p.id}')">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${p.hoTen} ${statusIndicator}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800">${p.namSinh}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800">${p.gioiTinh}</td>
                    <td class="px-6 py-4 text-sm text-slate-800 address-col">${p.diaChi || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800">${latestEncounter ? formatDate(latestEncounter.ngayKhamDate) : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800 text-center">${p.encounters.length}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800 text-center">${atStationCount}</td>
                </tr>`;
            }).join('');

            document.getElementById('patients-count').textContent = `Hiển thị ${filteredPatients.length} trên tổng số ${ncdPatients.length} bệnh nhân THA/ĐTĐ.`;
        }

        function renderHistoryView() {
            const container = document.getElementById('history-table-container');
            const { searchText, diseases, statuses } = appState.filters.history;
            const mode = appState.historySubTab;

            const relevantPatients = Object.values(appState.patients).filter(p => p.encounters.some(e => e.tinhTrang !== 'Không xác định'));
            if (relevantPatients.length === 0) {
                container.innerHTML = '<p class="p-4 text-center text-slate-500">Không có dữ liệu để hiển thị.</p>'; 
                document.getElementById('history-count').textContent = 'Hiển thị 0 bệnh nhân.';
                return;
            }

            const patientsToDisplay = relevantPatients.filter(patient => {
                return !searchText || patient.hoTen.toLowerCase().includes(searchText);
            });

            document.getElementById('history-count').textContent = `Hiển thị ${patientsToDisplay.length} bệnh nhân phù hợp.`;
            if (patientsToDisplay.length === 0) {
                container.innerHTML = '<p class="p-4 text-center text-slate-500">Không có bệnh nhân nào phù hợp với bộ lọc.</p>'; 
                return;
            }

            const allDates = relevantPatients.flatMap(p => p.encounters.map(e => e.ngayKhamDate));
            const minDate = new Date(Math.min.apply(null, allDates));
            const maxDate = new Date(Math.max.apply(null, allDates));

            const months = [];
            let currentDate = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
            while (currentDate <= maxDate) {
                months.push(new Date(currentDate));
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            const monthTimestamps = months.map(m => m.getTime());

            patientsToDisplay.forEach(p => {
                p.monthlyRecords = {};
                monthTimestamps.forEach(ts => p.monthlyRecords[ts] = false);
                p.encounters.forEach(e => {
                    const tinhTrangLower = e.tinhTrang.toLowerCase();
                    const diseaseMatch = diseases.length === 0 || diseases.some(d => (d === 'tha' && tinhTrangLower.includes('tăng huyết áp')) || (d === 'dtd' && tinhTrangLower.includes('đái tháo đường')));
                    const statusMatch = statuses.length === 0 || statuses.some(s => (s === 'tai tram' && tinhTrangLower.includes('tại trạm')) || (s === 'noi khac' && tinhTrangLower.includes('nơi khác')));
                    if(diseaseMatch && statusMatch) {
                        const monthStart = new Date(e.ngayKhamDate.getFullYear(), e.ngayKhamDate.getMonth(), 1).getTime();
                        p.monthlyRecords[monthStart] = true;
                    }
                });
            });

            const monthlyTotals = months.reduce((acc, m) => ({ ...acc, [m.getTime()]: 0 }), {});

            let tableHTML = `<table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50 sticky top-0 z-10">
                    <tr>
                        <th class="sticky-name px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sticky left-0 bg-slate-50 z-20">Họ và Tên</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Năm sinh</th>`;
            months.forEach((m, index) => tableHTML += `<th data-col-index="${index + 2}" class="month-header px-4 py-3 text-xs font-medium text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-200">${m.toLocaleString('vi-VN', { month: '2-digit', year: 'numeric' })}</th>`);
            tableHTML += `</tr><tr class="bg-slate-100"><th class="sticky left-0 bg-slate-100 z-20"></th><th></th>`;
            months.forEach(m => tableHTML += `<th id="total-${m.getTime()}" class="font-bold text-sky-600">0</th>`);
            tableHTML += `</tr></thead><tbody class="bg-white divide-y divide-slate-200">`;
            
            patientsToDisplay.forEach(patient => {
                tableHTML += `<tr>
                    <td class="sticky-name px-4 py-2 whitespace-nowrap text-sm font-medium text-slate-900 sticky left-0 bg-white">${patient.hoTen}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-slate-800">${patient.namSinh}</td>`;

                const recordIndices = monthTimestamps.map((ts, i) => patient.monthlyRecords[ts] ? i : -1).filter(i => i !== -1);
                let firstRecordIndex = recordIndices.length > 0 ? recordIndices[0] : -1;
                let dropped = false;
                let returned = false;
                let consecutiveEmpty = 0;

                monthTimestamps.forEach((ts, index) => {
                    let cellContent = '';
                    const hasRecord = patient.monthlyRecords[ts];
                    
                    // Exclude from count if patient is deceased/transferred before this month
                    const currentMonthDate = new Date(ts);
                    const shouldExclude = patient.status !== 'active' && patient.statusDate && patient.statusDate < currentMonthDate;
                    
                    if (!shouldExclude) {
                        if (mode === 'C' && hasRecord) {
                             cellContent = `<span class="flex items-center justify-center w-8 h-8 mx-auto bg-green-100 text-green-800 font-bold rounded-md">C</span>`;
                             monthlyTotals[ts]++;
                        } else if (mode === 'M' && index === firstRecordIndex) {
                            cellContent = `<span class="flex items-center justify-center w-8 h-8 mx-auto bg-sky-100 text-sky-800 font-bold rounded-md">M</span>`;
                            monthlyTotals[ts]++;
                        } else if (mode === 'B') {
                            if(hasRecord) { consecutiveEmpty = 0; } else { consecutiveEmpty++; }
                            if (consecutiveEmpty === 3) {
                                 cellContent = `<span class="flex items-center justify-center w-8 h-8 mx-auto bg-amber-100 text-amber-800 font-bold rounded-md">B</span>`;
                                 monthlyTotals[ts]++;
                                 dropped = true;
                            }
                        } else if (mode === 'Q') {
                             if(hasRecord) { consecutiveEmpty = 0; if(dropped && !returned){ cellContent = `<span class="flex items-center justify-center w-8 h-8 mx-auto bg-pink-100 text-pink-800 font-bold rounded-md">Q</span>`; monthlyTotals[ts]++; returned = true; } } else { consecutiveEmpty++; }
                             if (consecutiveEmpty >= 3) { dropped = true; returned = false; }
                        } else if (mode === 'QL') {
                            const isManaged = recordIndices.some(r_idx => index >= r_idx && index <= r_idx + 2);
                            if(isManaged){
                                cellContent = `<span class="flex items-center justify-center w-8 h-8 mx-auto bg-green-100 text-green-800 font-bold rounded-md">O</span>`;
                                monthlyTotals[ts]++;
                            }
                        }
                    }

                    tableHTML += `<td class="month-cell align-middle">${cellContent}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
            for(const ts in monthlyTotals) {
                const totalEl = document.getElementById(`total-${ts}`);
                if (totalEl) totalEl.textContent = monthlyTotals[ts];
            }
            container.querySelectorAll('th.month-header').forEach(header => {
                header.addEventListener('click', () => {
                    const colIndex = parseInt(header.dataset.colIndex);
                    const tbody = container.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    rows.sort((trA, trB) => {
                        const cellA = trA.children[colIndex];
                        const cellB = trB.children[colIndex];
                        const aHasMark = cellA && cellA.innerHTML.trim() !== '';
                        const bHasMark = cellB && cellB.innerHTML.trim() !== '';
                        return bHasMark - aHasMark;
                    });
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }
        
        function renderReferenceView() {
            createTagInput('tha-meds-container', appState.thaMeds, 'tha');
            createTagInput('dtd-meds-container', appState.dtdMeds, 'dtd');
        }

        function createTagInput(containerId, tags, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const tagContainer = document.createElement('div');
            tagContainer.className = 'tag-input-container';

            tags.forEach(tag => {
                const tagEl = document.createElement('span'); tagEl.className = 'tag'; tagEl.textContent = tag;
                const removeEl = document.createElement('span'); removeEl.className = 'tag-remove'; removeEl.textContent = 'x';
                removeEl.onclick = () => {
                    if (type === 'tha') appState.thaMeds = appState.thaMeds.filter(t => t !== tag);
                    else appState.dtdMeds = appState.dtdMeds.filter(t => t !== tag);
                    saveReferenceMeds();
                    renderReferenceView();
                    processData(appState.rawData);
                    renderAllViews();
                };
                tagEl.appendChild(removeEl);
                tagContainer.appendChild(tagEl);
            });

            const input = document.createElement('input'); input.type = 'text'; input.placeholder = 'Thêm thuốc...';
            input.className = 'flex-grow p-1 focus:outline-none bg-transparent';
            input.onkeyup = (e) => {
                if (e.key === 'Enter' && input.value.trim()) {
                    const newMed = input.value.trim().toLowerCase().replace(/[\s\W]/g, '');
                    if (type === 'tha' && !appState.thaMeds.includes(newMed)) appState.thaMeds.push(newMed);
                    else if (type === 'dtd' && !appState.dtdMeds.includes(newMed)) appState.dtdMeds.push(newMed);
                    saveReferenceMeds();
                    renderReferenceView();
                    input.value = '';
                    processData(appState.rawData);
                    renderAllViews();
                }
            };
            tagContainer.appendChild(input);
            container.appendChild(tagContainer);
        }

        function loadReferenceMeds() {
            const storedThaMeds = localStorage.getItem('thaMeds');
            const storedDtdMeds = localStorage.getItem('dtdMeds');
            appState.thaMeds = storedThaMeds ? JSON.parse(storedThaMeds) : [...DEFAULT_THA_MEDS];
            appState.dtdMeds = storedDtdMeds ? JSON.parse(storedDtdMeds) : [...new Set(DEFAULT_DTD_MEDS)];
        }

        function saveReferenceMeds() {
            localStorage.setItem('thaMeds', JSON.stringify(appState.thaMeds));
            localStorage.setItem('dtdMeds', JSON.stringify(appState.dtdMeds));
        }
        
        // --- FIX: Rewritten function for more accurate medication parsing ---
        function formatTreatment(dieuTri) {
            if (!dieuTri) return '<div class="p-3 bg-white rounded-md border text-slate-500 italic">Không có dữ liệu điều trị.</div>';
            
            const rawString = String(dieuTri).trim();
            // Split by number followed by a dot or colon, ensuring it's a list item
            const entries = rawString.split(/(?=\d+\.\s*|\d+:\s*)/).filter(s => s.trim());

            if (entries.length === 0) {
                return `<div class="p-3 bg-white rounded-md border text-slate-800">${rawString}</div>`;
            }

            let html = '<ol class="space-y-3">';
            entries.forEach((entry, index) => {
                const cleanedEntry = entry.replace(/^\d+[\.:]\s*/, '').trim();

                // Separate drug name + strength from the rest of the instructions
                let medNamePart = cleanedEntry;
                let usagePart = '';

                // Common delimiters for usage instructions
                const usageDelimiters = ['- uống', 'uống,', 'cách dùng'];
                let splitIndex = -1;

                for (const delimiter of usageDelimiters) {
                    const idx = medNamePart.toLowerCase().indexOf(delimiter);
                    if (idx !== -1) {
                        splitIndex = idx;
                        break;
                    }
                }
                
                if (splitIndex !== -1) {
                    usagePart = medNamePart.substring(splitIndex);
                    medNamePart = medNamePart.substring(0, splitIndex).trim();
                } else {
                    // If no clear delimiter, use heuristics
                    const words = cleanedEntry.split(/\s+/);
                    let potentialUsageIndex = -1;
                    // Find first word indicating usage like 'sáng', 'ngày', etc.
                    for (let i = 0; i < words.length; i++) {
                        if (['sáng', 's:', 'trưa', 't:', 'chiều', 'c:', 'tối', 'to:', 'ngày', 'uống'].includes(words[i].toLowerCase())) {
                            potentialUsageIndex = i;
                            break;
                        }
                    }
                    if (potentialUsageIndex > 0) {
                        medNamePart = words.slice(0, potentialUsageIndex).join(' ');
                        usagePart = words.slice(potentialUsageIndex).join(' ');
                    }
                }

                // Extract total quantity (e.g., x 30 Viên) from the name part
                const quantityMatch = medNamePart.match(/(x\s*\d+\s*\w+)$/i);
                let total = 'Không rõ SL';
                if (quantityMatch) {
                    total = quantityMatch[0].replace('x', '').trim();
                    medNamePart = medNamePart.replace(quantityMatch[0], '').trim();
                }
                
                const fullUsageString = (usagePart + ' ' + medNamePart).toLowerCase(); // Combine for easier matching

                const doseParts = [];
                const sangMatch = fullUsageString.match(/(?:sáng|s)\s*[:\-\s]\s*([\d\.\/]+\s*\w*)/i);
                const truaMatch = fullUsageString.match(/(?:trưa|t)\s*[:\-\s]\s*([\d\.\/]+\s*\w*)/i);
                const chieuMatch = fullUsageString.match(/(?:chiều|c)\s*[:\-\s]\s*([\d\.\/]+\s*\w*)/i);
                const toiMatch = fullUsageString.match(/(?:tối|to)\s*[:\-\s]\s*([\d\.\/]+\s*\w*)/i);

                if (sangMatch) doseParts.push(`Sáng ${sangMatch[1].trim()}`);
                if (truaMatch) doseParts.push(`Trưa ${truaMatch[1].trim()}`);
                if (chieuMatch) doseParts.push(`Chiều ${chieuMatch[1].trim()}`);
                if (toiMatch) doseParts.push(`Tối ${toiMatch[1].trim()}`);

                let usageLine = doseParts.join(' - ');
                
                const daysMatch = fullUsageString.match(/(?:số ngày|songay|sn)\s*[:\-\s]*(\d+)/i);
                const daysText = daysMatch ? `x ${daysMatch[1]} ngày` : '';

                if (!usageLine) {
                    const genericUsageMatch = fullUsageString.match(/ngày\s+\d+\s+lần/i);
                    usageLine = genericUsageMatch ? genericUsageMatch[0] : 'Không rõ cách dùng';
                }

                html += `<li class="p-3 bg-white rounded-md border border-slate-200 shadow-sm">
                            <div class="flex items-center justify-between">
                               <p class="font-semibold text-slate-800"><span class="text-sky-600 font-bold mr-2">${index + 1}.</span>${medNamePart}</p>
                               <p class="font-bold text-slate-700 text-right">${total}</p>
                            </div>
                            <p class="text-sm text-slate-500 mt-1 pl-6">${usageLine} ${daysText}</p>
                         </li>`;
            });
            html += '</ol>';
            return html;
        }


        function showDetailModal(patientId, encounterId = null) {
            const patient = appState.patients[patientId];
            if (!patient) return;
            
            appState.currentPatientId = patientId;
            modalTitle.textContent = `Hồ sơ bệnh nhân: ${patient.hoTen}`;

            const statusDateHtml = (statusType) => `
                <div id="${statusType}-date-container" class="${patient.status === statusType ? '' : 'hidden'} mt-2">
                    <label class="block text-xs font-medium text-gray-500">Ngày ${statusType === 'deceased' ? 'tử vong' : 'chuyển đi'}</label>
                    <input type="date" id="${statusType}-date" value="${patient.status === statusType && patient.statusDate ? formatDate(patient.statusDate, 'yyyy-mm-dd') : ''}" class="w-full p-1 border border-slate-300 rounded-md text-sm">
                </div>
            `;
            
            modalBody.innerHTML = `
                <div class="p-6 bg-white rounded-lg shadow-md border border-slate-200 mb-4">
                     <div class="grid grid-cols-1 md:grid-cols-[80px_1fr_250px] gap-6">
                        <div class="flex-shrink-0"><i data-lucide="user-circle-2" class="w-20 h-20 text-slate-400"></i></div>
                        
                        <div class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-2 text-sm">
                            <div>
                                <p class="text-xs text-slate-500">Họ và Tên</p>
                                <p class="text-lg font-bold text-slate-800">${patient.hoTen}</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500">Năm sinh</p>
                                <p class="font-semibold text-slate-700">${patient.namSinh}</p>
                            </div>
                             <div>
                                <p class="text-xs text-slate-500">Giới tính</p>
                                <p class="font-semibold text-slate-700">${patient.gioiTinh || 'N/A'}</p>
                            </div>
                            <div class="md:col-span-3">
                                <p class="text-xs text-slate-500">Địa chỉ</p>
                                <p class="font-semibold text-slate-700">${patient.diaChi || 'N/A'}</p>
                            </div>
                             <div>
                                <p class="text-xs text-slate-500">CCCD</p>
                                <p class="font-semibold text-slate-700">${patient.encounters[0]?.cccd || 'N/A'}</p>
                            </div>
                             <div>
                                <p class="text-xs text-slate-500">BHYT</p>
                                <p class="font-semibold text-slate-700">${patient.encounters[0]?.bhyt || 'N/A'}</p>
                            </div>
                        </div>

                        <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                             <h4 class="font-bold text-slate-800 mb-2 text-sm">Tình trạng bệnh nhân</h4>
                             <div class="space-y-2 text-sm">
                                <label class="flex items-center">
                                    <input type="radio" name="patient-status" value="active" ${patient.status === 'active' ? 'checked' : ''} class="form-radio h-4 w-4 text-sky-600">
                                    <span class="ml-2">Đang theo dõi</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="patient-status" value="deceased" ${patient.status === 'deceased' ? 'checked' : ''} class="form-radio h-4 w-4 text-sky-600">
                                    <span class="ml-2">Tử vong</span>
                                </label>
                                ${statusDateHtml('deceased')}
                                <label class="flex items-center">
                                    <input type="radio" name="patient-status" value="transferred" ${patient.status === 'transferred' ? 'checked' : ''} class="form-radio h-4 w-4 text-sky-600">
                                    <span class="ml-2">Chuyển đi nơi khác</span>
                                </label>
                                ${statusDateHtml('transferred')}
                             </div>
                        </div>
                     </div>
                </div>

                <div class="bg-white rounded-lg shadow-md border border-slate-200">
                    <div class="p-2 bg-slate-100 border-b border-slate-200 rounded-t-lg">
                        <div id="detail-tabs-container" class="inline-flex space-x-1">
                            <button data-tab="history" class="detail-tab-btn detail-tab-active font-semibold px-4 py-2 rounded-md text-sm transition flex items-center gap-2"><i data-lucide="history"></i> Lịch sử khám</button>
                            <button data-tab="chart" class="detail-tab-btn bg-transparent text-gray-600 hover:bg-gray-200 font-semibold px-4 py-2 rounded-md text-sm transition flex items-center gap-2"><i data-lucide="line-chart"></i> Biểu đồ tuân thủ</button>
                        </div>
                    </div>
                    <div id="detail-tab-content" class="p-4">
                        <div id="detail-history-view">
                            <div class="grid grid-cols-1 md:grid-cols-[250px_1fr] gap-6 items-start">
                                <div>
                                    <h4 class="font-semibold text-sm mb-2 text-slate-600">Chọn lần khám</h4>
                                    <div id="history-sidebar" class="max-h-[55vh] overflow-y-auto pr-2 border rounded-md p-2 bg-slate-50">${renderHistorySidebar(patient, encounterId)}</div>
                                </div>
                                <div id="visit-detail-container" class="min-h-[55vh]"></div>
                            </div>
                        </div>
                        <div id="detail-chart-view" class="hidden">
                           ${renderAdherenceChartView()}
                        </div>
                    </div>
                </div>
            `;
            
            const targetEncounterId = encounterId || (patient.encounters.length > 0 ? patient.encounters[0].id : null);
            if(targetEncounterId) {
                renderVisitDetail(patient.id, targetEncounterId);
            }

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('scale-95');
            lucide.createIcons();
            
            // --- EVENT LISTENERS FOR NEW FEATURES ---
            addPatientStatusListeners(patientId);
            addDetailTabsListeners();
        }
        
        function addPatientStatusListeners(patientId) {
            const patient = appState.patients[patientId];
            const statusRadios = document.querySelectorAll('input[name="patient-status"]');
            const deceasedDateContainer = document.getElementById('deceased-date-container');
            const transferredDateContainer = document.getElementById('transferred-date-container');
            const deceasedDateInput = document.getElementById('deceased-date');
            const transferredDateInput = document.getElementById('transferred-date');

            statusRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    appState.isDirty = true;
                    const newStatus = e.target.value;
                    patient.status = newStatus;
                    deceasedDateContainer.classList.toggle('hidden', newStatus !== 'deceased');
                    transferredDateContainer.classList.toggle('hidden', newStatus !== 'transferred');
                    
                    if (newStatus === 'active') {
                        patient.statusDate = null;
                        deceasedDateInput.value = '';
                        transferredDateInput.value = '';
                    } else if (newStatus === 'deceased') {
                        patient.statusDate = deceasedDateInput.value ? new Date(deceasedDateInput.value) : null;
                    } else if (newStatus === 'transferred') {
                        patient.statusDate = transferredDateInput.value ? new Date(transferredDateInput.value) : null;
                    }
                    renderPatientsView(); // Re-render patient list to show status change
                });
            });

            deceasedDateInput.addEventListener('change', (e) => {
                appState.isDirty = true;
                patient.statusDate = e.target.value ? new Date(e.target.value) : null;
            });
            transferredDateInput.addEventListener('change', (e) => {
                appState.isDirty = true;
                patient.statusDate = e.target.value ? new Date(e.target.value) : null;
            });
        }
        
        function addDetailTabsListeners() {
            document.getElementById('detail-tabs-container').addEventListener('click', e => {
                const button = e.target.closest('.detail-tab-btn');
                if (!button) return;

                document.querySelectorAll('.detail-tab-btn').forEach(btn => {
                    btn.classList.remove('detail-tab-active');
                    btn.classList.add('bg-transparent', 'text-gray-600', 'hover:bg-gray-200');
                });
                button.classList.add('detail-tab-active');
                button.classList.remove('bg-transparent', 'text-gray-600', 'hover:bg-gray-200');

                const targetTab = button.dataset.tab;
                document.getElementById('detail-history-view').classList.toggle('hidden', targetTab !== 'history');
                document.getElementById('detail-chart-view').classList.toggle('hidden', targetTab !== 'chart');
                
                if (targetTab === 'chart') {
                    renderAdherenceChart(appState.currentPatientId);
                }
            });
        }
        
        function renderHistorySidebar(patient, activeEncounterId) {
            const selectedId = activeEncounterId || (patient.encounters.length > 0 ? patient.encounters[0].id : null);
            return patient.encounters.map(e => `
                <div onclick="switchVisitView('${patient.id}', '${e.id}')"
                   class="sidebar-link block text-sm p-2 rounded-md mb-1 cursor-pointer transition-colors ${e.id === selectedId ? 'bg-sky-200 font-semibold' : 'hover:bg-slate-200'}"
                   data-encounter-id="${e.id}">
                   ${formatDate(e.ngayKhamDate)} - ${e.tinhTrang.split(';')[0]}
                </div>
            `).join('');
        }
        
        function switchVisitView(patientId, encounterId) {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('bg-sky-200', 'font-semibold');
                link.classList.add('hover:bg-slate-200');
            });
            const activeLink = document.querySelector(`.sidebar-link[data-encounter-id="${encounterId}"]`);
            if (activeLink) {
                 activeLink.classList.add('bg-sky-200', 'font-semibold');
                 activeLink.classList.remove('hover:bg-slate-200');
            }
            renderVisitDetail(patientId, encounterId);
        }

        function renderVisitDetail(patientId, encounterId) {
            const patient = appState.patients[patientId];
            const encounter = patient.encounters.find(e => e.id === encounterId);
            const container = document.getElementById('visit-detail-container');

            if (!encounter) {
                container.innerHTML = '<p>Không tìm thấy chi tiết lần khám.</p>';
                return;
            }

            const diagnosesHTML = (encounter.chanDoan || 'N/A').split(';').map(d => `<li class="flex items-start"><span class="text-orange-500 mr-2 mt-1">&#9679;</span><span>${d.trim()}</span></li>`).join('');

            container.innerHTML = `
                <div class="visit-card space-y-4">
                    <div class="flex justify-between items-center pb-3 border-b">
                         <h3 class="font-bold text-lg text-sky-700">Ngày khám: ${formatDate(encounter.ngayKhamDate)} (Tuổi: ${encounter.tuoi})</h3>
                         <span class="text-xs font-semibold px-2.5 py-1 rounded-full ${encounter.tinhTrang.includes('tại trạm') ? 'bg-sky-100 text-sky-800' : 'bg-amber-100 text-amber-800'}">${encounter.tinhTrang}</span>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="space-y-4">
                            <div class="p-4 bg-white rounded-lg border border-slate-200 shadow-sm">
                                <h4 class="font-semibold text-green-700 border-l-4 border-green-500 pl-2 mb-3">Sinh hiệu & Triệu chứng</h4>
                                <p class="text-sm text-slate-600 mb-3">${cleanSymptomsString(encounter.trieuChung)}</p>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    ${Object.entries(encounter.vitals).map(([key, value]) => `
                                        <div class="p-2 rounded-md ${key === 'Huyết áp' && value !== 'N/A' ? 'bg-red-100' : 'bg-slate-100'}">
                                            <p class="text-slate-500 text-xs">${key}</p>
                                            <p class="font-semibold text-slate-800">${value}</p>
                                        </div>`).join('')}
                                </div>
                            </div>
                            <div class="p-4 bg-white rounded-lg border border-slate-200 shadow-sm">
                                <h4 class="font-semibold text-orange-700 border-l-4 border-orange-500 pl-2 mb-3">Chẩn đoán</h4>
                                <ul class="text-sm text-slate-800 space-y-1">${diagnosesHTML}</ul>
                            </div>
                        </div>
                        <div class="lg:col-span-1 p-4 bg-white rounded-lg border border-slate-200 shadow-sm">
                            <h4 class="font-semibold text-purple-700 border-l-4 border-purple-500 pl-2 mb-3">Phương pháp điều trị</h4>
                            <div class="max-h-[40vh] overflow-y-auto pr-2">
                                ${formatTreatment(encounter.dieuTri)}
                            </div>
                        </div>
                    </div>
                     <div class="p-4 bg-white rounded-lg border border-slate-200 shadow-sm">
                        <h4 class="font-semibold text-indigo-700 border-l-4 border-indigo-500 pl-2 mb-3">Ghi chú cho lần khám này</h4>
                        <textarea id="encounter-note-${encounter.id}" class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500 text-sm" rows="3" placeholder="Thêm ghi chú...">${encounter.note || ''}</textarea>
                    </div>
                </div>
            `;
            // Add listener for the new note textarea
            const noteTextarea = document.getElementById(`encounter-note-${encounter.id}`);
            noteTextarea.addEventListener('input', (e) => {
                encounter.note = e.target.value;
                appState.isDirty = true; // Mark data as modified
            });
        }
        
        function renderAdherenceChartView() {
            return `
                <div id="adherence-chart-controls" class="mb-4 p-3 bg-slate-50 rounded-md border flex flex-wrap items-center gap-6">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phân tích theo bệnh</label>
                        <select id="adherence-disease-filter" class="p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500 text-sm">
                            <option value="tha">Tăng huyết áp</option>
                            <option value="dtd">Đái tháo đường</option>
                        </select>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phân tích theo nơi điều trị</label>
                        <select id="adherence-location-filter" class="p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500 text-sm">
                            <option value="tại trạm">Điều trị tại trạm</option>
                            <option value="nơi khác">Điều trị nơi khác</option>
                        </select>
                    </div>
                </div>
                <div class="relative h-96">
                    <canvas id="adherenceChart"></canvas>
                </div>
            `;
        }

        function renderAdherenceChart(patientId) {
            const patient = appState.patients[patientId];
            if (!patient) return;
            
            const diseaseFilter = document.getElementById('adherence-disease-filter').value;
            const locationFilter = document.getElementById('adherence-location-filter').value;
            
            const diseaseKeyword = diseaseFilter === 'tha' ? 'tăng huyết áp' : 'đái tháo đường';

            const relevantEncounters = patient.encounters.filter(e => {
                const statusLower = e.tinhTrang.toLowerCase();
                return statusLower.includes(diseaseKeyword) && statusLower.includes(locationFilter);
            }).sort((a,b) => a.ngayKhamDate - b.ngayKhamDate);
            
            if (relevantEncounters.length === 0) {
                 if (chartInstances.adherence) chartInstances.adherence.destroy();
                 const canvas = document.getElementById('adherenceChart');
                 const ctx = canvas.getContext('2d');
                 ctx.clearRect(0,0, canvas.width, canvas.height);
                 ctx.font = '16px "Be Vietnam Pro"';
                 ctx.fillStyle = '#64748b';
                 ctx.textAlign = 'center';
                 ctx.fillText('Không có dữ liệu tuân thủ cho lựa chọn này.', canvas.width / 2, canvas.height / 2);
                 return;
            }

            const firstVisit = relevantEncounters[0].ngayKhamDate;
            let lastVisit = new Date(); // Use today as the end date for timeline
            if (patient.status !== 'active' && patient.statusDate) {
                lastVisit = patient.statusDate; // Stop tracking after deceased/transferred date
            }
            
            const months = [];
            let currentDate = new Date(firstVisit.getFullYear(), firstVisit.getMonth(), 1);
            while (currentDate <= lastVisit) {
                months.push(new Date(currentDate));
                currentDate.setMonth(currentDate.getMonth() + 1);
            }

            const visitsByMonth = {};
            relevantEncounters.forEach(e => {
                const monthKey = `${e.ngayKhamDate.getFullYear()}-${e.ngayKhamDate.getMonth()}`;
                visitsByMonth[monthKey] = true;
            });
            
            const adherenceData = [];
            const pointColors = [];
            const ADHERENCE_LEVELS = { MAX: 3, WARN1: 2, WARN2: 1, DROPPED: 0 };
            const ADHERENCE_COLORS = { 3: '#22c55e', 2: '#facc15', 1: '#f97316', 0: '#ef4444' };
            
            let consecutiveMisses = 0;
            months.forEach(month => {
                const monthKey = `${month.getFullYear()}-${month.getMonth()}`;
                let level;
                if(visitsByMonth[monthKey]) {
                    consecutiveMisses = 0;
                    level = ADHERENCE_LEVELS.MAX;
                } else {
                    consecutiveMisses++;
                    level = Math.max(ADHERENCE_LEVELS.DROPPED, ADHERENCE_LEVELS.MAX - consecutiveMisses);
                }
                adherenceData.push(level);
                pointColors.push(ADHERENCE_COLORS[level]);
            });

            if (chartInstances.adherence) {
                chartInstances.adherence.destroy();
            }
            
            const ctx = document.getElementById('adherenceChart').getContext('2d');
            chartInstances.adherence = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months.map(m => m.toLocaleString('vi-VN', { month: '2-digit', year: 'numeric' })),
                    datasets: [{
                        label: 'Mức độ tuân thủ',
                        data: adherenceData,
                        borderColor: '#94a3b8',
                        pointBackgroundColor: pointColors,
                        pointBorderColor: pointColors,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        tension: 0.1,
                        stepped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 3.5,
                            ticks: {
                                stepSize: 1,
                                callback: function(value, index, values) {
                                    switch(value) {
                                        case 3: return 'Tái khám';
                                        case 2: return 'Vắng 1 tháng';
                                        case 1: return 'Vắng 2 tháng';
                                        case 0: return 'Bỏ trị';
                                        default: return '';
                                    }
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                     const level = context.parsed.y;
                                     let label = '';
                                     switch(level) {
                                        case 3: label = 'Tuân thủ tốt (Tái khám)'; break;
                                        case 2: label = 'Cảnh báo (Vắng 1 tháng)'; break;
                                        case 1: label = 'Nguy cơ (Vắng 2 tháng)'; break;
                                        case 0: label = 'Bỏ trị (Vắng >= 3 tháng)'; break;
                                     }
                                     return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- EVENT LISTENERS ---
        uploadButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            if (appState.isDirty) {
                 if (!confirm("Bạn có dữ liệu chưa lưu (ghi chú, tình trạng bệnh nhân). Tải lên file mới sẽ làm mất các thay đổi này. Bạn có chắc chắn muốn tiếp tục?")) {
                    fileInput.value = ''; // Reset file input
                    return;
                }
            }

            fileNameDisplay.textContent = `Tệp đã chọn: ${file.name}`;
            loadingOverlay.classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('sổ khám')) || workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                    
                    appState.rawData = jsonData;
                    setTimeout(() => {
                        processData(jsonData);
                        populateAllMonthFilters(); // Populate filters right after processing data
                        loadingOverlay.classList.add('hidden');
                        uploadContainer.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        const firstTab = document.querySelector('.tab-button[data-tab="dashboard"]');
                        firstTab.click();
                        fileInput.value = '';
                    }, 500);
                } catch(err) {
                    loadingOverlay.classList.add('hidden');
                    fileNameDisplay.textContent = 'Lỗi: Không thể đọc tệp. Vui lòng kiểm tra định dạng.';
                    showAlert("Lỗi: Không thể đọc tệp Excel. Vui lòng kiểm tra lại.", "error");
                    console.error(err);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;
                appState.activeTab = targetTab;
                tabButtons.forEach(btn => { 
                    btn.classList.remove('tab-active'); 
                    btn.classList.add('text-slate-500', 'hover:text-slate-700', 'hover:border-slate-300');
                });
                button.classList.add('tab-active'); 
                button.classList.remove('text-slate-500', 'hover:text-slate-700', 'hover:border-slate-300');

                tabPanes.forEach(pane => pane.id === `${targetTab}-view` ? pane.classList.remove('hidden') : pane.classList.add('hidden'));
                
                if (appState.rawData.length > 0) {
                    const viewRenderers = {
                        'dashboard': renderDashboard, 'report': renderReportView, 'export': renderExportView,
                        'all-encounters': renderAllEncountersView, 'ncd-encounters': renderNcdEncountersView,
                        'patients': renderPatientsView, 'history': renderHistoryView, 'reference': renderReferenceView,
                    };
                    if(viewRenderers[targetTab]) viewRenderers[targetTab]();
                }
            });
        });
        
        document.getElementById('dashboard-filters').addEventListener('click', (e) => {
            if (e.target.classList.contains('dashboard-filter-btn')) {
                appState.dashboardFilter = e.target.dataset.filter;
                document.querySelectorAll('.dashboard-filter-btn').forEach(btn => {
                    btn.classList.remove('history-sub-tab-active');
                    btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                });
                e.target.classList.add('history-sub-tab-active');
                e.target.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                renderDashboard();
            }
        });
        
        document.getElementById('history-sub-tabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('history-sub-tab')) {
                appState.historySubTab = e.target.dataset.mode;
                document.querySelectorAll('.history-sub-tab').forEach(btn => {
                    btn.classList.remove('history-sub-tab-active');
                    btn.classList.add('bg-transparent', 'text-gray-600', 'hover:bg-gray-200');
                });
                e.target.classList.add('history-sub-tab-active');
                e.target.classList.remove('bg-transparent', 'text-gray-600', 'hover:bg-gray-200');
                renderHistoryView();
            }
        });
        
        modalBody.addEventListener('change', e => {
            if (e.target.id === 'adherence-disease-filter' || e.target.id === 'adherence-location-filter') {
                if (appState.currentPatientId) {
                    renderAdherenceChart(appState.currentPatientId);
                }
            }
        });


        closeModalButtons.forEach(btn => btn.addEventListener('click', () => {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('scale-95');
            appState.currentPatientId = null;
        }));

        document.getElementById('all-encounters-search').addEventListener('input', (e) => { appState.filters.allEncounters.searchText = e.target.value; renderAllEncountersView(); });
        document.getElementById('all-encounters-month-filter').addEventListener('change', (e) => { appState.filters.allEncounters.month = e.target.value; renderAllEncountersView(); });
        document.getElementById('all-encounters-reset-filters').addEventListener('click', () => {
             document.getElementById('all-encounters-search').value = '';
             document.getElementById('all-encounters-month-filter').value = 'all';
             appState.filters.allEncounters = { searchText: '', month: 'all' };
             renderAllEncountersView();
        });

        document.getElementById('ncd-filters').addEventListener('input', () => {
            appState.filters.ncdEncounters = {
                searchText: document.getElementById('ncd-encounters-search').value,
                month: document.getElementById('ncd-month-filter').value,
                birthYear: document.getElementById('ncd-birthyear-filter').value,
                gender: document.getElementById('ncd-gender-filter').value,
                diseases: Array.from(document.querySelectorAll('input[name="ncd-disease-filter"]:checked')).map(cb => cb.value),
                statuses: Array.from(document.querySelectorAll('input[name="ncd-status-filter"]:checked')).map(cb => cb.value),
            };
            renderNcdEncountersView();
        });
        document.getElementById('ncd-reset-filters').addEventListener('click', () => {
            document.getElementById('ncd-encounters-search').value = '';
            document.getElementById('ncd-month-filter').value = 'all';
            document.getElementById('ncd-birthyear-filter').value = '';
            document.getElementById('ncd-gender-filter').value = 'all';
            document.querySelectorAll('input[name="ncd-disease-filter"]:checked').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="ncd-status-filter"]:checked').forEach(cb => cb.checked = false);
            appState.filters.ncdEncounters = { searchText: '', month: 'all', birthYear: '', gender: 'all', diseases: [], statuses: [] };
            renderNcdEncountersView();
        });

        document.getElementById('patients-search').addEventListener('input', (e) => { appState.filters.patients.searchText = e.target.value; renderPatientsView(); });
        document.getElementById('patients-month-filter').addEventListener('change', (e) => { appState.filters.patients.month = e.target.value; renderPatientsView(); });
        document.getElementById('patients-reset-filters').addEventListener('click', () => {
            document.getElementById('patients-search').value = '';
            document.getElementById('patients-month-filter').value = 'all';
            appState.filters.patients = { searchText: '', month: 'all' };
            renderPatientsView();
        });

        document.getElementById('history-filters').addEventListener('input', (e) => { 
            if (e.target.id === 'history-search') appState.filters.history.searchText = e.target.value;
            else {
                 appState.filters.history.diseases = Array.from(document.querySelectorAll('#history-filters input[name="disease"]:checked')).map(cb => cb.value);
                 appState.filters.history.statuses = Array.from(document.querySelectorAll('#history-filters input[name="status"]:checked')).map(cb => cb.value);
            }
            renderHistoryView();
        });

        document.getElementById('report-period').addEventListener('change', (e) => {
            const period = e.target.value;
            document.getElementById('month-selector-container').style.display = period === 'month' ? 'block' : 'none';
            document.getElementById('custom-date-container').style.display = period === 'custom' ? 'grid' : 'none';
        });

        document.getElementById('generate-report-btn').addEventListener('click', () => {
            const period = document.getElementById('report-period').value;
            const population = parseInt(document.getElementById('report-population').value, 10) || 0;
            let startDate, endDate;
            const now = new Date();
            now.setHours(23, 59, 59, 999); 

            if (period === 'month') {
                const [year, month] = document.getElementById('report-month').value.split('-').map(Number);
                startDate = new Date(year, month - 1, 1);
                endDate = new Date(year, month, 0, 23, 59, 59, 999);
            } else if (period === '3months') {
                endDate = new Date(now);
                startDate = new Date(now); startDate.setMonth(startDate.getMonth() - 3); startDate.setDate(1);
            } else if (period === '6months') {
                endDate = new Date(now);
                startDate = new Date(now); startDate.setMonth(startDate.getMonth() - 6); startDate.setDate(1);
            } else if (period === 'custom') {
                startDate = new Date(document.getElementById('report-start-date').value);
                endDate = new Date(document.getElementById('report-end-date').value);
                endDate.setHours(23, 59, 59, 999);
            }
            startDate.setHours(0, 0, 0, 0);

            if (!startDate || !endDate || isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
                 document.getElementById('report-output').innerHTML = `<div class="info-card text-red-600">Vui lòng chọn khoảng thời gian hợp lệ.</div>`;
                 return;
            }
            
            generateReport(startDate, endDate, population);
        });

        document.getElementById('export-period').addEventListener('change', (e) => {
            const period = e.target.value;
            document.getElementById('export-month-selector-container').style.display = period === 'month' ? 'block' : 'none';
            document.getElementById('export-custom-date-container').style.display = period === 'custom' ? 'grid' : 'none';
        });

        document.getElementById('export-excel-btn').addEventListener('click', generatePatientListExcel);

        function generateReport(startDate, endDate, population) {
            const outputContainer = document.getElementById('report-output');
            const thaData = calculateReportMetrics('tha', startDate, endDate, population, 0.12);
            const dtdData = calculateReportMetrics('dtd', startDate, endDate, population, 0.02);
            outputContainer.innerHTML = `${createReportSectionHTML('Tăng huyết áp', thaData)}${createReportSectionHTML('Đái tháo đường', dtdData)}`;
            lucide.createIcons();
        }
        
        function getHistoryBasedMetrics(patientsForStatus, periodStart, periodEnd, diseaseKeyword, statusFilter) {
            const medicatedPatientIds = new Set();
            patientsForStatus.forEach(p => {
                if (p.encounters.some(e => e.ngayKhamDate >= periodStart && e.ngayKhamDate <= periodEnd && e.tinhTrang.toLowerCase().includes(diseaseKeyword) && (statusFilter === 'all' || e.tinhTrang.toLowerCase().includes(statusFilter)))) {
                    medicatedPatientIds.add(p.id);
                }
            });
            let newlyDetected = 0;
            patientsForStatus.forEach(p => {
                const firstRelevantEncounter = [...p.encounters].reverse().find(e => e.tinhTrang.toLowerCase().includes(diseaseKeyword) && (statusFilter === 'all' || e.tinhTrang.toLowerCase().includes(statusFilter)));
                if (firstRelevantEncounter && firstRelevantEncounter.ngayKhamDate >= periodStart && firstRelevantEncounter.ngayKhamDate <= periodEnd) {
                    newlyDetected++;
                }
            });
            const managementPeriodStart = new Date(periodStart);
            managementPeriodStart.setMonth(managementPeriodStart.getMonth() - 2);
            const underManagementPatientIds = new Set();
            patientsForStatus.forEach(p => {
                if (p.encounters.some(e => e.ngayKhamDate >= managementPeriodStart && e.ngayKhamDate <= periodEnd && e.tinhTrang.toLowerCase().includes(diseaseKeyword) && (statusFilter === 'all' || e.tinhTrang.toLowerCase().includes(statusFilter)))) {
                    underManagementPatientIds.add(p.id);
                }
            });
            
            // Calculate total detected and real managed up to the end of the period
            let totalDetectedToDate = 0;
            let realManagedToDate = 0;
            Object.values(appState.patients).forEach(p => {
                const hasDisease = p.encounters.some(e => e.ngayKhamDate <= periodEnd && e.tinhTrang.toLowerCase().includes(diseaseKeyword));
                if (hasDisease) {
                    totalDetectedToDate++;
                    const isInactive = p.status !== 'active' && p.statusDate && p.statusDate <= periodEnd;
                    if (!isInactive) {
                        realManagedToDate++;
                    }
                }
            });
            
            const medicated = medicatedPatientIds.size;
            return { newlyDetected, underManagement: underManagementPatientIds.size, medicated, targetAchieved: Math.round(medicated * 0.20), totalDetected: totalDetectedToDate, realManaged: realManagedToDate };
        }

        function calculateReportMetrics(diseaseType, startDate, endDate, population, prevalenceRate) {
            const keyword = diseaseType === 'tha' ? 'tăng huyết áp' : 'đái tháo đường';
            const getMetricsForPeriod = (periodStart, periodEnd, statusFilter) => {
                const allRelevantPatientIds = new Set();
                appState.encounters.forEach(e => {
                    const statusLower = e.tinhTrang.toLowerCase();
                    if (statusLower.includes(keyword) && (statusFilter === 'all' || statusLower.includes(statusFilter))) {
                        allRelevantPatientIds.add(`${e.hoTen.trim()}_${e.namSinhNum}`);
                    }
                });
                const patientsForStatus = Array.from(allRelevantPatientIds).map(id => appState.patients[id]).filter(Boolean);
                const metrics = getHistoryBasedMetrics(patientsForStatus, periodStart, periodEnd, keyword, statusFilter);
                return { detectedEstimate: Math.round(population * prevalenceRate), ...metrics };
            };
            const lastYearStartDate = new Date(startDate); lastYearStartDate.setFullYear(lastYearStartDate.getFullYear() - 1);
            const lastYearEndDate = new Date(endDate); lastYearEndDate.setFullYear(lastYearEndDate.getFullYear() - 1);
            const currentData = { taiTram: getMetricsForPeriod(startDate, endDate, 'tại trạm'), noiKhac: getMetricsForPeriod(startDate, endDate, 'nơi khác'), tongHop: getMetricsForPeriod(startDate, endDate, 'all') };
            const lastYearData = { taiTram: getMetricsForPeriod(lastYearStartDate, lastYearEndDate, 'tại trạm'), noiKhac: getMetricsForPeriod(lastYearStartDate, lastYearEndDate, 'nơi khác'), tongHop: getMetricsForPeriod(lastYearStartDate, lastYearEndDate, 'all') };
            const calculateComparison = (currentMetrics, lastYearMetrics) => {
                const result = {};
                for (const key in currentMetrics) {
                    const current = currentMetrics[key], last = lastYearMetrics[key];
                    let change = null;
                    if (last > 0) change = Math.round(((current - last) / last) * 100);
                    else if (current > 0) change = null;
                    result[key] = { value: current, lastYearValue: last, change };
                }
                return result;
            };
            return { taiTram: calculateComparison(currentData.taiTram, lastYearData.taiTram), noiKhac: calculateComparison(currentData.noiKhac, lastYearData.noiKhac), tongHop: calculateComparison(currentData.tongHop, lastYearData.tongHop) };
        }

        function createReportSectionHTML(title, data) {
             const createMetricComparisonHTML = (metric, isSpecial = false) => {
                let comparisonText = `<p class="text-xs text-slate-500 mt-1">Cùng kỳ: ${metric.lastYearValue}</p>`;
                 if (isSpecial) { // Don't show comparison for estimates or totals
                     return `<p class="text-xs text-slate-500 mt-1">&nbsp;</p>`;
                 }
                if (metric.change === null || isNaN(metric.change)) return comparisonText + (metric.value > 0 && metric.lastYearValue === 0 ? `<p class="text-xs font-semibold text-green-500">Mới</p>` : '');
                const color = metric.change >= 0 ? 'text-green-500' : 'text-red-500', icon = metric.change >= 0 ? 'arrow-up' : 'arrow-down', sign = metric.change > 0 ? '+' : '';
                return comparisonText + `<p class="text-xs font-semibold ${color} inline-flex items-center"><i data-lucide="${icon}" class="w-3 h-3 mr-1"></i> ${sign}${metric.change}%</p>`;
            };
            const createSubSection = (subTitle, metrics, note) => `
            <div class="p-4 bg-slate-50 rounded-lg border">
                <h4 class="font-semibold text-slate-700 mb-3">${subTitle}</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 text-sm">
                    <div class="bg-white p-3 rounded-md border lg:col-span-2 grid grid-cols-2 gap-2">
                         <div class="border-r pr-2">
                             <p class="text-slate-500">Ước tính phát hiện</p>
                             <p class="text-xl font-bold text-sky-600">${metrics.detectedEstimate.value}</p>
                             <p class="text-xs text-slate-400 mt-1">${note}</p>
                         </div>
                         <div>
                             <p class="text-slate-500">Tổng đã phát hiện</p>
                             <p class="text-xl font-bold text-sky-600">${metrics.totalDetected.value}</p>
                             ${createMetricComparisonHTML(metrics.totalDetected, true)}
                         </div>
                         <div class="border-r pr-2">
                            <p class="text-slate-500 text-green-600 font-semibold">Số quản lý thực tế</p>
                             <p class="text-xl font-bold text-green-600">${metrics.realManaged.value}</p>
                            <p class="text-xs text-slate-400 mt-1">(Trừ tử vong/chuyển đi)</p>
                         </div>
                    </div>
                    <div class="bg-white p-3 rounded-md border">
                        <p class="text-slate-500">Số mới phát hiện</p>
                        <p class="text-xl font-bold text-sky-600">${metrics.newlyDetected.value}</p>
                        ${createMetricComparisonHTML(metrics.newlyDetected)}
                    </div>
                    <div class="bg-white p-3 rounded-md border">
                        <p class="text-slate-500">Số đang quản lí</p>
                        <p class="text-xl font-bold text-sky-600">${metrics.underManagement.value}</p>
                        ${createMetricComparisonHTML(metrics.underManagement)}
                    </div>
                    <div class="bg-white p-3 rounded-md border">
                        <p class="text-slate-500">Số khám cấp thuốc</p>
                        <p class="text-xl font-bold text-sky-600">${metrics.medicated.value}</p>
                        ${createMetricComparisonHTML(metrics.medicated)}
                    </div>
                    <div class="bg-white p-3 rounded-md border">
                        <p class="text-slate-500">Điều trị đạt mục tiêu</p>
                        <p class="text-xl font-bold text-sky-600">${metrics.targetAchieved.value}</p>
                        ${createMetricComparisonHTML(metrics.targetAchieved)}
                        <p class="text-xs text-slate-400 mt-1">(Ước tính 20%)</p>
                    </div>
                </div>
            </div>`;
            const note = title === 'Tăng huyết áp' ? '(Ước tính 12% dân số)' : '(Ước tính 2% dân số)';
            return `<div class="info-card"><h3 class="text-xl font-bold mb-4 text-sky-700">${title}</h3><div class="space-y-4">${createSubSection('Điều trị tại trạm', data.taiTram, note)}${createSubSection('Điều trị nơi khác', data.noiKhac, note)}${createSubSection('Tổng hợp', data.tongHop, note)}</div></div>`;
        }

        function generatePatientListExcel() {
            const exportBtn = document.getElementById('export-excel-btn');
            const originalBtnHTML = exportBtn.innerHTML;
            exportBtn.disabled = true;
            exportBtn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> Đang xử lý...`;
            lucide.createIcons();
            const oldMsg = document.getElementById('export-error-msg');
            if (oldMsg) oldMsg.remove();
            const selectedDiseases = Array.from(document.querySelectorAll('#export-view input[name="export-disease"]:checked')).map(cb => cb.value);
            const selectedStatuses = Array.from(document.querySelectorAll('#export-view input[name="export-status"]:checked')).map(cb => cb.value);
            const period = document.getElementById('export-period').value;
            let startDate, endDate;
            if (period === 'month') {
                const [year, month] = document.getElementById('export-month').value.split('-').map(Number);
                startDate = new Date(year, month - 1, 1);
                endDate = new Date(year, month, 0, 23, 59, 59, 999);
            } else {
                startDate = new Date(document.getElementById('export-start-date').value);
                endDate = new Date(document.getElementById('export-end-date').value);
                startDate.setHours(0, 0, 0, 0);
                endDate.setHours(23, 59, 59, 999);
            }
            const patientData = {};
            appState.encounters.forEach(e => {
                if (e.ngayKhamDate >= startDate && e.ngayKhamDate <= endDate) {
                    const statusLower = e.tinhTrang.toLowerCase();
                    const diseaseMatch = selectedDiseases.length === 0 || selectedDiseases.some(d => statusLower.includes(d));
                    const statusMatch = selectedStatuses.length === 0 || selectedStatuses.some(s => statusLower.includes(s));
                    if (diseaseMatch && statusMatch) {
                        const patientId = `${e.hoTen.trim()}_${e.namSinhNum}`;
                        if (!patientData[patientId]) {
                            const patientInfo = appState.patients[patientId];
                            patientData[patientId] = { hoTen: patientInfo.hoTen, gioiTinh: patientInfo.gioiTinh, namSinh: patientInfo.namSinh, diaChi: patientInfo.diaChi, encounters: [] };
                        }
                        patientData[patientId].encounters.push(e);
                    }
                }
            });
            const tableData = Object.values(patientData).map((p, index) => {
                const visitDates = p.encounters.map(e => formatDate(e.ngayKhamDate)).join('; ');
                return [index + 1, p.hoTen, p.gioiTinh || 'N/A', p.namSinh, p.diaChi || 'N/A', p.encounters.length, visitDates];
            });
            if (tableData.length === 0) {
                 const msgEl = document.createElement('p');
                 msgEl.id = 'export-error-msg';
                 msgEl.className = 'text-red-500 text-sm ml-4 absolute bottom-0 mb-[-25px]';
                 msgEl.textContent = 'Không có dữ liệu phù hợp.';
                 exportBtn.parentElement.style.position = 'relative';
                 exportBtn.parentElement.appendChild(msgEl);
                 exportBtn.disabled = false; exportBtn.innerHTML = originalBtnHTML; lucide.createIcons();
                 setTimeout(() => msgEl.remove(), 3000);
                 return;
            }
            try {
                const headers = ['STT', 'Họ và Tên', 'Giới tính', 'Năm sinh', 'Địa chỉ', 'Số lần khám', 'Ghi chú (ngày khám)'];
                const dataToExport = [headers, ...tableData];
                const worksheet = XLSX.utils.aoa_to_sheet(dataToExport);
                worksheet['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 10 }, { wch: 10 }, { wch: 40 }, { wch: 15 }, { wch: 40 }];
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'DanhSachBenhNhan');
                XLSX.writeFile(workbook, `Danh_sach_benh_nhan_${new Date().toISOString().slice(0,10)}.xlsx`);
            } catch(err) {
                console.error("Error generating Excel file:", err);
            } finally {
                exportBtn.disabled = false; exportBtn.innerHTML = originalBtnHTML; lucide.createIcons();
            }
        }

        // --- NEW: Function to export data for saving ---
        document.getElementById('export-save-data-btn').addEventListener('click', () => {
            const btn = document.getElementById('export-save-data-btn');
            const statusEl = document.getElementById('export-save-status');
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i> Đang tạo file...`;
            lucide.createIcons();
            statusEl.textContent = '';

            setTimeout(() => {
                try {
                    let outputData = appState.rawData.map(row => [...row]); // Deep copy
                    const newHeaders = ['Ghi chú', 'Ngày tử vong', 'Ngày chuyển đi'];
                    const existingHeaders = appState.rawHeaders.map(h => String(h || '').toLowerCase().trim());
                    
                    let noteColIdx = existingHeaders.indexOf('ghi chú');
                    let deceasedColIdx = existingHeaders.indexOf('ngày tử vong');
                    let transferredColIdx = existingHeaders.indexOf('ngày chuyển đi');

                    if (noteColIdx === -1) { noteColIdx = outputData[appState.headerRowIndex].length; outputData[appState.headerRowIndex].push('Ghi chú'); }
                    if (deceasedColIdx === -1) { deceasedColIdx = outputData[appState.headerRowIndex].length; outputData[appState.headerRowIndex].push('Ngày tử vong'); }
                    if (transferredColIdx === -1) { transferredColIdx = outputData[appState.headerRowIndex].length; outputData[appState.headerRowIndex].push('Ngày chuyển đi'); }
                    
                    const patientLastNcdEncounter = {};
                     Object.values(appState.patients).forEach(p => {
                        const lastNcdEncounter = p.encounters.find(e => e.tinhTrang !== 'Không xác định');
                        if (lastNcdEncounter) {
                            patientLastNcdEncounter[p.id] = lastNcdEncounter.id;
                        }
                    });

                    appState.encounters.forEach(encounter => {
                        const rowIndex = encounter.originalRowIndex;
                        if(outputData[rowIndex]) {
                            outputData[rowIndex][noteColIdx] = encounter.note || '';

                            const patientId = `${String(encounter.hoTen).trim()}_${encounter.namSinhNum}`;
                            // Only write status date on the row of the last NCD encounter
                            if (patientLastNcdEncounter[patientId] === encounter.id) {
                                const patient = appState.patients[patientId];
                                if (patient.status === 'deceased' && patient.statusDate) {
                                    outputData[rowIndex][deceasedColIdx] = formatDate(patient.statusDate);
                                }
                                if (patient.status === 'transferred' && patient.statusDate) {
                                     outputData[rowIndex][transferredColIdx] = formatDate(patient.statusDate);
                                }
                            }
                        }
                    });

                    const worksheet = XLSX.utils.aoa_to_sheet(outputData);
                    const workbook = XLSX.utils.book_new();
                    const sheetName = appState.rawData[0] ? (appState.rawData[0].find(c => typeof c === 'string' && c.toLowerCase().includes('sổ khám')) || 'Sổ khám bệnh') : 'Sổ khám bệnh';

                    XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                    XLSX.writeFile(workbook, `Du_lieu_QL_BKL_${new Date().toISOString().slice(0,10)}.xlsx`);

                    statusEl.textContent = 'Xuất file thành công!';
                    statusEl.className = 'text-sm mt-2 text-green-600';
                    appState.isDirty = false; // Data is now saved
                } catch (err) {
                    console.error("Error exporting save data:", err);
                    statusEl.textContent = 'Đã có lỗi xảy ra khi xuất file.';
                    statusEl.className = 'text-sm mt-2 text-red-600';
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = `<i data-lucide="download"></i> Xuất file Excel để lưu trữ`;
                    lucide.createIcons();
                }
            }, 500);
        });

        // --- NEW: Add beforeunload listener to warn about unsaved data ---
        window.addEventListener('beforeunload', (event) => {
            if (appState.isDirty) {
                event.preventDefault();
                event.returnValue = ''; // Required for Chrome
                return ''; // For other browsers
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadReferenceMeds();
            lucide.createIcons();
        });
    </script>
</body>
</html>
```
